<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - INitro AI Marketing Intelligence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #06b6d4;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --border-color: #e2e8f0;
            --gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
        }
        
        .sidebar {
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .sidebar-nav {
            padding: 20px 0;
        }
        
        .nav-item {
            margin-bottom: 5px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #64748b;
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 0;
        }
        
        .nav-link:hover,
        .nav-link.active {
            background: linear-gradient(90deg, var(--primary-color), transparent);
            color: var(--primary-color);
            border-right: 3px solid var(--primary-color);
        }
        
        .nav-link i {
            width: 20px;
            margin-right: 12px;
        }
        
        .main-content {
            margin-left: 280px;
            padding: 30px;
            min-height: 100vh;
        }
        
        .top-bar {
            background: white;
            padding: 20px 30px;
            margin: -30px -30px 30px -30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .card {
            background: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background: transparent;
            border-bottom: 1px solid var(--border-color);
            padding: 20px 25px;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .card-body {
            padding: 25px;
        }
        
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--light-color);
        }
        
        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .btn-primary-custom {
            background: var(--gradient);
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }
        
        .btn-outline-custom {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            background: transparent;
            transition: all 0.3s ease;
        }
        
        .btn-outline-custom:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .progress-custom {
            height: 8px;
            border-radius: 10px;
            background: var(--border-color);
            overflow: hidden;
        }
        
        .progress-bar-custom {
            background: var(--gradient);
            transition: width 0.3s ease;
        }
        
        .alert-custom {
            border: none;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }
        
        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }
        
        .alert-info {
            background: rgba(6, 182, 212, 0.1);
            color: var(--accent-color);
            border-left: 4px solid var(--accent-color);
        }
        
        .result-container {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-json {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .thinking-log {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .thinking-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-left: 3px solid var(--primary-color);
            background: white;
            border-radius: 4px;
        }
        
        .thinking-timestamp {
            color: #6c757d;
            font-size: 0.75rem;
            margin-bottom: 4px;
        }
        
        .segment-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        
        .segment-header {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .goal-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--success-color);
            transition: all 0.3s ease;
        }
        
        .goal-item.approved-goal {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
            transform: scale(1.02);
        }
        
        .campaign-card {
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .campaign-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .campaign-title, .campaign-header {
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 8px;
            font-size: 1.2em;
        }
        
        .campaign-card .btn-group .btn {
            border-radius: 6px;
            margin-left: 4px;
        }
        
        .campaign-card .btn-group .btn:first-child {
            margin-left: 0;
        }
        
        .campaign-card .form-label {
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 6px;
        }
        
        .campaign-card .form-control {
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: border-color 0.3s ease;
        }
        
        .campaign-card .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 1.5rem;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-toggle {
                display: block;
            }
        }
        
        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        /* Chat Widget Styles */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
        
        .chat-message {
            margin-bottom: 15px;
            animation: slideInUp 0.3s ease-out;
        }
        
        .chat-message.user {
            text-align: right;
        }
        
        .chat-message.assistant {
            text-align: left;
        }
        
        .message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .message-bubble.user {
            background: var(--gradient);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-bubble.assistant {
            background: white;
            color: var(--dark-color);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 4px;
        }
        
        .typing-dots {
            display: inline-flex;
            align-items: center;
        }
        
        .typing-dots .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--primary-color);
            margin: 0 2px;
            animation: typingDot 1.4s ease-in-out infinite;
        }
        
        .typing-dots .dot:nth-child(1) { animation-delay: 0s; }
        .typing-dots .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots .dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #chat-widget-container.collapsed {
            display: none;
        }
        
        .quick-suggestions .btn {
            font-size: 0.75rem;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 12px;
        }
        
        /* Enhanced Analytics Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .analytics-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .analytics-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 1rem;
        }
        
        .analytics-header h4 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .analytics-body {
            padding: 1.5rem;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-weight: 500;
            color: #6b7280;
        }
        
        .metric-value {
            font-weight: 700;
            color: #1f2937;
        }
        
        .channel-metric {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .channel-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        
        .channel-stats {
            color: #6b7280;
        }
        
        /* Performance Dashboard Styles */
        .performance-dashboard {
            margin-top: 1rem;
        }
        
        .performance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .summary-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .summary-content h3 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .summary-content p {
            margin: 0;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .performance-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        
        .performance-table h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        
        /* Insights Styles */
        .insights-container {
            margin-top: 1rem;
        }
        
        .insights-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .insights-section h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        
        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .insight-item:last-child {
            border-bottom: none;
        }
        
        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }
        
        .insight-icon.success {
            background: #10b981;
        }
        
        .insight-icon.info {
            background: #3b82f6;
        }
        
        .insight-icon.warning {
            background: #f59e0b;
        }
        
        .insight-content h5 {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
        }
        
        .insight-content p {
            margin: 0;
            color: #6b7280;
        }
        
        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .recommendation-item:last-child {
            border-bottom: none;
        }
        
        .recommendation-priority {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        .recommendation-priority.high {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .recommendation-priority.medium {
            background: #fef3c7;
            color: #d97706;
        }
        
        .recommendation-priority.low {
            background: #d1fae5;
            color: #059669;
        }
        
        .recommendation-content h5 {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
        }
        
        .recommendation-content p {
            margin: 0 0 0.5rem 0;
            color: #6b7280;
        }
        
        .recommendation-impact {
            color: #4b5563;
            font-style: italic;
        }
        
        /* Weekly Forecast Styles */
        .weekly-forecast-chart {
            display: flex;
            gap: 1rem;
            align-items: end;
            height: 200px;
            padding: 1rem 0;
        }
        
        .week-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .week-label {
            font-weight: 600;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .week-metrics {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            height: 150px;
        }
        
        .conversions-bar {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            width: 30px;
            border-radius: 4px;
            min-height: 10px;
        }
        
        .week-stats {
            text-align: center;
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        /* Performance Distribution Styles */
        .distribution-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .distribution-item:last-child {
            border-bottom: none;
        }
        
        .distribution-label {
            min-width: 120px;
            font-weight: 500;
            color: #1f2937;
        }
        
        .distribution-bar {
            flex: 1;
            height: 20px;
            background: #f3f4f6;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .distribution-fill {
            height: 100%;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .distribution-value {
            min-width: 80px;
            text-align: right;
            font-weight: 600;
            color: #1f2937;
        }
        
        /* Segment and Audience Styles */
        .audience-summary {
            margin-bottom: 1rem;
        }
        
        .segment-breakdown {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .segment-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .segment-item:last-child {
            border-bottom: none;
        }
        
        .segment-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        
        .segment-stats {
            color: #6b7280;
        }

    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <i class="fas fa-brain me-2"></i>INitro
            </div>
            <div class="mt-2">
                <a href="{{ url_for('landing_page') }}" class="nav-link" style="padding: 8px 0; color: #64748b;">
                    <i class="fas fa-home me-2"></i>Home
                </a>
            </div>
        </div>
        <nav class="sidebar-nav">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#upload-section">
                        <i class="fas fa-upload"></i>
                        Upload Data
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#process-section">
                        <i class="fas fa-cogs"></i>
                        Process Agents
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#campaigns-section">
                        <i class="fas fa-bullhorn"></i>
                        Campaign Generation
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#campaign-management">
                        <i class="fas fa-tasks"></i>
                        Campaign Management
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#results-section">
                        <i class="fas fa-chart-bar"></i>
                        Results
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link agent-name" href="#">
                        <i class="fas fa-robot"></i>
                        INitro Agent
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="d-flex align-items-center">
                <button class="mobile-toggle me-3" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">AI Marketing Dashboard</h1>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span class="text-muted">System Online</span>
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshPage()" title="Refresh Page">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="clearCache()" title="Clear Cache & Memory">
                    <i class="fas fa-trash-alt"></i> Clear Cache
                </button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-brain text-white"></i>
                </div>
                <div class="stat-number" id="agent1-status">Ready</div>
                <div class="stat-label">Agent 1 Status</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="stat-number" id="agent2-status">Ready</div>
                <div class="stat-label">Agent 2 Status</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-upload"></i>
                </div>
                <div class="stat-number" id="files-processed">0</div>
                <div class="stat-label">Files Processed</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-number" id="last-update">Never</div>
                <div class="stat-label">Last Update</div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="card" id="upload-section">
            <div class="card-header">
                <i class="fas fa-upload me-2"></i>Data Upload
            </div>
            <div class="card-body">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h4>Upload Your Data</h4>
                    <p class="text-muted mb-3">
                        Drag and drop your files here or click to browse<br>
                        Supported formats: CSV, JSON, Excel (.xlsx, .xls)
                    </p>
                    <input type="file" id="fileInput" accept=".csv,.json,.xlsx,.xls" style="display: none;" multiple>
                    <button class="btn btn-primary-custom">
                        <i class="fas fa-folder-open me-2"></i>Choose Files
                    </button>
                </div>
                
                <div id="file-list" class="mt-3" style="display: none;">
                    <h6>Selected Files:</h6>
                    <ul id="selected-files" class="list-unstyled"></ul>
                </div>
                
                <div class="mt-3">
                    <button id="upload-btn" class="btn btn-primary-custom" style="display: none;" onclick="uploadFiles()">
                        <i class="fas fa-upload me-2"></i>Upload Files
                    </button>
                    <button class="btn btn-outline-custom ms-2" onclick="useSampleData()">
                        <i class="fas fa-database me-2"></i>Use Sample Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Process Section -->
        <div class="card" id="process-section">
            <div class="card-header">
                <i class="fas fa-cogs me-2"></i>Agent Processing
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Process your data through our AI agent system for advanced analytics and insights.
                </p>
                
                <!-- Real-time Status Display -->
                <div id="agent-status-container" style="display: block;">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-primary" id="agent1-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <span class="me-3" style="color: #ff0000; font-size: 3rem; font-weight: bold;">🧠</span>
                                        <div>
                                            <h5 class="mb-0">Agent 1: Analytics</h5>
                                            <small class="text-muted">Customer segmentation & campaigns</small>
                                        </div>
                                        <div class="ms-auto">
                                            <div id="agent1-spinner" class="spinner-border spinner-border-sm text-primary" style="display: none;"></div>
                                            <i id="agent1-status-icon" class="fas fa-clock text-muted"></i>
                                        </div>
                                    </div>
                                    <div id="agent1-status-text" class="text-muted">Waiting to start...</div>
                                    <div id="agent1-progress" class="mt-2">
                                        <div class="progress" style="height: 4px;">
                                            <div id="agent1-progress-bar" class="progress-bar bg-primary" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div id="agent1-details" class="mt-2" style="display: none;">
                                        <small class="text-muted">Current step: <span id="agent1-step">-</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-secondary" id="agent2-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="fas fa-cogs fa-2x text-secondary me-3"></i>
                                        <div>
                                            <h5 class="mb-0">Agent 2: Context Engine</h5>
                                            <small class="text-muted">Knowledge base & decision making</small>
                                        </div>
                                        <div class="ms-auto">
                                            <div id="agent2-spinner" class="spinner-border spinner-border-sm text-secondary" style="display: none;"></div>
                                            <i id="agent2-status-icon" class="fas fa-clock text-muted"></i>
                                        </div>
                                    </div>
                                    <div id="agent2-status-text" class="text-muted">Waiting for Agent 1...</div>
                                    <div id="agent2-progress" class="mt-2">
                                        <div class="progress" style="height: 4px;">
                                            <div id="agent2-progress-bar" class="progress-bar bg-secondary" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div id="agent2-details" class="mt-2" style="display: none;">
                                        <small class="text-muted">Current step: <span id="agent2-step">-</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Approval/Review Section -->
                    <div id="approval-section" class="card border-warning" style="display: none;">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-user-check fa-2x text-warning me-3"></i>
                                <div>
                                    <h5 class="mb-0">Human Review Required</h5>
                                    <small class="text-muted">Agent is waiting for approval</small>
                                </div>
                                <div class="ms-auto">
                                    <div class="spinner-border spinner-border-sm text-warning"></div>
                                </div>
                            </div>
                            <div id="approval-message" class="text-muted mb-3">Waiting for review...</div>
                            <div id="approval-data" class="small text-muted" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                

                
                <div class="text-center mt-4">
                    <button id="process-btn" class="btn btn-primary-custom btn-lg" onclick="processAgents()">
                        <i class="fas fa-play me-2"></i>Start Processing
                    </button>
                    <button id="stop-btn" class="btn btn-outline-danger btn-lg ms-2" onclick="stopProcessing()" style="display: none;">
                        <i class="fas fa-stop me-2"></i>Stop Processing
                    </button>
                </div>
                
                <div class="loading-spinner" id="loading-spinner">
                    <div class="spinner"></div>
                    <p>Processing data through AI agents...</p>
                </div>
                
                <!-- Agent Output Display -->
                <div id="agent-output-section" class="mt-4" style="display: block;">
                    <h5><i class="fas fa-brain text-primary"></i> Agent Output & Thinking</h5>
                    
                    <!-- Agent 1 Output -->
                    <div id="agent1-output" class="mb-4">
                        <h6 class="text-primary"><i class="fas fa-brain"></i> Agent 1 - Marketing Strategist</h6>
                        
                        <!-- Customer Segments -->
                        <div id="segments-section" class="mb-3" style="display: block;">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-users"></i> Customer Segments Generated</h6>
                                </div>
                                <div class="card-body">
                                    <div id="segments-content"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Business Goals -->
                        <div id="goals-section" class="mb-3" style="display: block;">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-bullseye"></i> Business Goals</h6>
                                </div>
                                <div class="card-body">
                                    <div id="goals-content"></div>
                                    <div id="goals-approval" class="mt-3" style="display: none;">
                                        <div class="alert alert-warning">
                                            <strong>🔧 Goal Management Options:</strong> Please review and manage the generated business goals.
                                            
                                            <!-- Goal Selection -->
                                            <div class="mt-3">
                                                <h6>Select Goals to Approve:</h6>
                                                <div id="goal-checkboxes" class="mb-3"></div>
                                                <button class="btn btn-success btn-sm me-2" onclick="approveSelectedGoals()">Approve Selected</button>
                                                <button class="btn btn-success btn-sm me-2" onclick="approveAllGoals()">Approve All</button>
                                            </div>
                                            
                                            <!-- Goal CRUD Operations -->
                            <div class="mt-3">
                                <h6>Edit Goals (CRUD Operations):</h6>
                                <div class="alert alert-info alert-sm">
                                    <small><i class="fas fa-info-circle"></i> You can edit goals one at a time. Select a goal, make changes, save, then select another goal to continue editing.</small>
                                </div>
                                <select id="goal-edit-select" class="form-select mb-2">
                                    <option value="">Select a goal to edit...</option>
                                </select>
                                

                                
                                <!-- Goal Edit Form -->
                                <div id="goal-edit-form" style="display: none;" class="border p-3 mt-2 rounded">
                                    <h6 class="text-primary">Edit Goal Details</h6>
                                    
                                    <div class="mb-2">
                                        <label class="form-label">Goal Name:</label>
                                        <input type="text" id="edit-goal-name" class="form-control" placeholder="Enter goal name...">
                                    </div>
                                    
                                    <div class="mb-2">
                                        <label class="form-label">Description:</label>
                                        <textarea id="edit-goal-description" class="form-control" rows="2" placeholder="Enter goal description..."></textarea>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <label class="form-label">Priority:</label>
                                        <select id="edit-goal-priority" class="form-select">
                                            <option value="high">High</option>
                                            <option value="medium">Medium</option>
                                            <option value="low">Low</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <label class="form-label">Target Segments (comma-separated):</label>
                                        <input type="text" id="edit-goal-segments" class="form-control" placeholder="e.g., young adults, professionals, students">
                                    </div>
                                    
                                    <div class="mb-2">
                                        <label class="form-label">Success Metrics (comma-separated):</label>
                                        <input type="text" id="edit-goal-metrics" class="form-control" placeholder="e.g., conversion rate, engagement, ROI">
                                    </div>
                                    
                                    <div class="mb-2">
                                        <label class="form-label">Timeline:</label>
                                        <input type="text" id="edit-goal-timeline" class="form-control" placeholder="e.g., 3 months, Q1 2024">
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-success btn-sm me-2" onclick="saveGoalChanges()">Save Changes</button>

                                        <button class="btn btn-danger btn-sm me-2" onclick="deleteGoal()">Delete Goal</button>
                                        <button class="btn btn-secondary btn-sm" onclick="cancelGoalEdit()">Cancel</button>
                                    </div>
                                </div>
                            </div>
                                            
                                            <!-- Reject Goals -->
                                            <div class="mt-3">
                                                <h6>Reject Goals:</h6>
                                                <select id="goal-reject-select" class="form-select mb-2">
                                                    <option value="">Select a goal to reject...</option>
                                                </select>
                                                <button class="btn btn-danger btn-sm" onclick="rejectSelectedGoal()">Reject Selected Goal</button>
                                            </div>
                                            
                                            <!-- Add Custom Goal -->
                                            <div class="mt-3">
                                                <h6>Add Custom Goal:</h6>
                                                <input type="text" id="custom-goal-title" class="form-control mb-2" placeholder="Goal title...">
                                                <textarea id="custom-goal-description" class="form-control mb-2" placeholder="Goal description..." rows="2"></textarea>
                                                <button class="btn btn-primary btn-sm" onclick="addCustomGoal()">Add Custom Goal</button>
                                            </div>
                                            
                                            <!-- Finish Selection -->
                                            <div class="mt-3 text-center">
                                                <button class="btn btn-success" onclick="finishGoalSelection()">Finish Goal Selection</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Marketing Campaigns -->
                        <div id="campaigns-section" class="mb-3" style="display: block;">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-bullhorn"></i> Marketing Campaigns</h6>
                                </div>
                                <div class="card-body">
                                    <div id="campaigns-content"></div>
                                    <div id="campaigns-review" class="mt-3" style="display: none;">
                                        <div class="alert alert-info">
                                            <strong>Review Required:</strong> Please review the generated marketing campaigns.
                                            <div class="mt-2">
                                                <button class="btn btn-success btn-sm me-2" onclick="approveCampaigns()">Approve All</button>
                                                <button class="btn btn-warning btn-sm" onclick="modifyCampaigns()">Request Changes</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Agent 2 Output -->
                    <div id="agent2-output" class="mb-4" style="display: block;">
                        <h6 class="text-secondary"><i class="fas fa-cogs"></i> Agent 2 - Implementation Specialist</h6>
                        
                        <!-- Implementation Plans -->
                        <div id="implementation-section" class="mb-3">
                            <div class="card">
                                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-tasks"></i> Implementation Plans</h6>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="downloadImplementationPlan('json')" title="Download as JSON">
                                            <i class="fas fa-file-code"></i> JSON
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="downloadImplementationPlan('excel')" title="Download as Excel">
                                            <i class="fas fa-file-excel"></i> Excel
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="downloadImplementationPlan('pdf')" title="Download as PDF">
                                            <i class="fas fa-file-pdf"></i> PDF
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="implementation-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Thinking Process Display -->
                    <div id="thinking-process" class="mb-4">
                        <h6 class="text-muted"><i class="fas fa-brain text-white"></i> Agent Thinking Process</h6>
                        <div class="card">
                            <div class="card-body">
                                <div id="thinking-log" class="thinking-log">
                                    <!-- Real-time thinking updates will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign Management Section -->
        <div class="card" id="campaign-management">
            <div class="card-header">
                <i class="fas fa-tasks me-2"></i>Campaign Management
            </div>
            <div class="card-body">
                <!-- Campaign Controls -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary" onclick="showCreateCampaignForm()">
                                    <i class="fas fa-plus me-2"></i>Create New Campaign
                                </button>

                            <button type="button" class="btn btn-success" onclick="launchSelectedCampaigns()">
                                <i class="fas fa-rocket me-2"></i>Launch Selected
                            </button>
                            <button type="button" class="btn btn-warning" onclick="pauseSelectedCampaigns()">
                                <i class="fas fa-pause me-2"></i>Pause Selected
                            </button>
                            <button type="button" class="btn btn-danger" onclick="deleteSelectedCampaigns()">
                                <i class="fas fa-trash me-2"></i>Delete Selected
                            </button>
                            <button type="button" class="btn btn-info" onclick="refreshCampaigns()">
                                <i class="fas fa-sync me-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Campaign Creation/Edit Form -->
                <div id="campaign-form-section" class="row mb-4" style="display: none;">
                    <div class="col-12">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0" id="campaign-form-title"><i class="fas fa-plus me-2"></i>Create New Campaign</h6>
                            </div>
                            <div class="card-body">
                                <form id="campaign-form">
                                    <input type="hidden" id="campaign-id" value="">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="campaign-name" class="form-label">Campaign Name *</label>
                                                <input type="text" class="form-control" id="campaign-name" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="campaign-description" class="form-label">Description *</label>
                                                <textarea class="form-control" id="campaign-description" rows="3" required></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label for="campaign-budget" class="form-label">Budget Estimate</label>
                                                <input type="text" class="form-control" id="campaign-budget" placeholder="e.g., $10,000 - $15,000">
                                            </div>
                                            <div class="mb-3">
                                                <label for="campaign-timeline" class="form-label">Timeline</label>
                                                <input type="text" class="form-control" id="campaign-timeline" placeholder="e.g., 4-6 weeks">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="campaign-targets" class="form-label">Target Segments</label>
                                                <textarea class="form-control" id="campaign-targets" rows="2" placeholder="Enter target segments separated by commas"></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label for="campaign-channels" class="form-label">Marketing Channels</label>
                                                <textarea class="form-control" id="campaign-channels" rows="2" placeholder="Enter channels separated by commas"></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label for="campaign-goals" class="form-label">Business Goals</label>
                                                <textarea class="form-control" id="campaign-goals" rows="2" placeholder="Enter business goals separated by commas"></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label for="campaign-metrics" class="form-label">Success Metrics</label>
                                                <textarea class="form-control" id="campaign-metrics" rows="2" placeholder="Enter success metrics separated by commas"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-success me-2">
                                                <i class="fas fa-save me-2"></i>Save Campaign
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="cancelCampaignForm()">
                                <i class="fas fa-times me-2"></i>Cancel
                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campaigns List -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-bullhorn me-2"></i>All Campaigns</h6>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="select-all-campaigns" onchange="toggleAllCampaigns()">
                                    <label class="form-check-label text-white" for="select-all-campaigns">Select All</label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="campaigns-list">
                                    <p class="text-muted">No campaigns available. Create a new campaign or generate campaigns using the AI agents.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campaign Performance Summary -->
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="card-title text-primary" id="total-campaigns">0</h5>
                                <p class="card-text">Total Campaigns</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="card-title text-success" id="active-campaigns-count">0</h5>
                                <p class="card-text">Active Campaigns</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="card-title text-warning" id="paused-campaigns-count">0</h5>
                                <p class="card-text">Paused Campaigns</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comprehensive Results Section -->
        <div class="card" id="results-section" style="display: block;">
            <div class="card-header bg-gradient-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-chart-line me-2"></i>Processing Results & Analytics
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-light" onclick="exportResults('json')">
                            <i class="fas fa-download me-1"></i>JSON
                        </button>
                        <button type="button" class="btn btn-outline-light" onclick="exportResults('excel')">
                            <i class="fas fa-file-excel me-1"></i>Excel
                        </button>
                        <button type="button" class="btn btn-outline-light" onclick="refreshResults()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Results Navigation Tabs -->
                <ul class="nav nav-tabs" id="results-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-pane" type="button" role="tab">
                            <i class="fas fa-tachometer-alt me-2"></i>Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="agent-results-tab" data-bs-toggle="tab" data-bs-target="#agent-results-pane" type="button" role="tab">
                            <i class="fas fa-robot me-2"></i>Agent Results
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics-pane" type="button" role="tab">
                            <i class="fas fa-chart-bar me-2"></i>Analytics
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance-pane" type="button" role="tab">
                            <i class="fas fa-gauge-high me-2"></i>Performance
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="insights-tab" data-bs-toggle="tab" data-bs-target="#insights-pane" type="button" role="tab">
                            <i class="fas fa-lightbulb me-2"></i>Insights
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="results-tab-content">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview-pane" role="tabpanel">
                        <div class="p-4">
                            <!-- Summary Cards -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-users fa-2x mb-2"></i>
                                            <h4 id="total-segments">0</h4>
                                            <small>Customer Segments</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-bullseye fa-2x mb-2"></i>
                                            <h4 id="total-goals">0</h4>
                                            <small>Business Goals</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-bullhorn fa-2x mb-2"></i>
                                            <h4 id="total-campaigns-result">0</h4>
                                            <small>Generated Campaigns</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-clock fa-2x mb-2"></i>
                                            <h4 id="processing-time">0s</h4>
                                            <small>Processing Time</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Processing Status -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Processing Status</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="processing-status-content">
                                                <div class="text-center text-muted py-3">
                                                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                                                    <p>No processing results available. Start processing to see results here.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Activity -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activity</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="recent-activity-content">
                                                <div class="text-center text-muted py-3">
                                                    <i class="fas fa-clock fa-2x mb-2"></i>
                                                    <p>No recent activity to display.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Results Tab -->
                    <div class="tab-pane fade" id="agent-results-pane" role="tabpanel">
                        <div class="p-4">
                            <!-- Agent 1 Results -->
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-brain me-2"></i>Agent 1: Analytics Results</h6>
                                </div>
                                <div class="card-body">
                                    <div id="agent1-results-content">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-brain fa-2x mb-2"></i>
                                            <p>No Agent 1 results available yet.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Agent 2 Results -->
                            <div class="card mb-4">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Agent 2: Context Engine Results</h6>
                                </div>
                                <div class="card-body">
                                    <div id="agent2-results-content">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-cogs fa-2x mb-2"></i>
                                            <p>No Agent 2 results available yet.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Combined Results -->
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-handshake me-2"></i>Combined Agent Results</h6>
                                </div>
                                <div class="card-body">
                                    <div id="combined-results-content">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-handshake fa-2x mb-2"></i>
                                            <p>No combined results available yet.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div class="tab-pane fade" id="analytics-pane" role="tabpanel">
                        <div class="p-4">
                            <!-- Customer Segments Analytics -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-users me-2"></i>Customer Segments Analysis</h6>
                                </div>
                                <div class="card-body">
                                    <div id="segments-analytics-content">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-chart-pie fa-2x mb-2"></i>
                                            <p>No segment analytics available. Process data to see segment analysis.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Campaign Performance Analytics -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Campaign Performance Analysis</h6>
                                </div>
                                <div class="card-body">
                                    <div id="campaigns-analytics-content">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                                            <p>No campaign analytics available. Generate campaigns to see performance analysis.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Quality Metrics -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Data Quality Metrics</h6>
                                </div>
                                <div class="card-body">
                                    <div id="data-quality-content">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-database fa-2x mb-2"></i>
                                            <p>No data quality metrics available. Upload data to see quality analysis.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Tab -->
                    <div class="tab-pane fade" id="performance-pane" role="tabpanel">
                        <div class="p-4">
                            <!-- Processing Performance -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Processing Performance</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="text-primary" id="agent1-processing-time">0s</h5>
                                                    <small>Agent 1 Processing Time</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="text-secondary" id="agent2-processing-time">0s</h5>
                                                    <small>Agent 2 Processing Time</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="text-success" id="total-processing-time">0s</h5>
                                                    <small>Total Processing Time</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="text-info" id="data-processing-rate">0 records/s</h5>
                                                    <small>Data Processing Rate</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- System Resources -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-server me-2"></i>System Resources</h6>
                                </div>
                                <div class="card-body">
                                    <div id="system-resources-content">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-server fa-2x mb-2"></i>
                                            <p>System resource monitoring will appear here during processing.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Insights Tab -->
                    <div class="tab-pane fade" id="insights-pane" role="tabpanel">
                        <div class="p-4">
                            <!-- Key Insights -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Key Insights</h6>
                                </div>
                                <div class="card-body">
                                    <div id="key-insights-content">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-lightbulb fa-2x mb-2"></i>
                                            <p>Key insights will be generated after processing your data.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recommendations -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-thumbs-up me-2"></i>AI Recommendations</h6>
                                </div>
                                <div class="card-body">
                                    <div id="recommendations-content">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-thumbs-up fa-2x mb-2"></i>
                                            <p>AI-powered recommendations will appear here after analysis.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Items -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>Suggested Action Items</h6>
                                </div>
                                <div class="card-body">
                                    <div id="action-items-content">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-tasks fa-2x mb-2"></i>
                                            <p>Suggested action items will be provided based on your results.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Assistant Chat Section -->
        <div class="card" id="chat-section">
            <div class="card-header">
                <i class="fas fa-robot me-2"></i>INitro Agent
                <button class="btn btn-sm btn-outline-primary ms-auto" onclick="toggleChatWidget()" id="chat-toggle-btn">
                    <i class="fas fa-expand" id="chat-toggle-icon"></i>
                </button>
            </div>
            <div class="card-body p-0" id="chat-widget-container">
                <!-- Chat Widget -->
                <div id="chat-widget" class="d-flex flex-column" style="height: 400px;">
                    <!-- Chat Messages Area -->
                    <div id="chat-messages" class="flex-grow-1 p-3 custom-scrollbar" style="overflow-y: auto; background-color: #f8fafc;">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-robot fa-2x mb-2" style="color: var(--primary-color);"></i>
                            <p class="mb-0">Hello! I'm your INitro Agent.</p>
                            <p class="small">Ask me about campaigns, analytics, or marketing strategies.</p>
                        </div>
                    </div>
                    
                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="px-3 py-2" style="display: none; background-color: #f8fafc;">
                        <div class="d-flex align-items-center text-muted">
                            <div class="typing-dots me-2">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                            <small>AI is thinking...</small>
                        </div>
                    </div>
                    
                    <!-- Chat Input Area -->
                    <div class="border-top p-3" style="background-color: white;">
                        <div class="input-group">
                            <input type="text" id="chat-input" class="form-control" placeholder="Ask me anything about marketing..." 
                                   onkeypress="handleChatKeyPress(event)" style="border-radius: 25px 0 0 25px;">
                            <button class="btn btn-primary-custom" onclick="sendChatMessage()" id="send-btn" 
                                    style="border-radius: 0 25px 25px 0;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="mt-2">
                            <div class="d-flex flex-wrap gap-1" id="quick-suggestions">
                                <button class="btn btn-sm btn-outline-secondary" onclick="sendQuickMessage('Analyze my campaign performance')">
                                    📊 Campaign Analysis
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="sendQuickMessage('Suggest marketing strategies')">
                                    💡 Strategy Ideas
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="sendQuickMessage('Help with customer segmentation')">
                                    🎯 Segmentation
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Container -->
        <div id="alerts-container"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        let filesProcessed = 0;
        let socket = null;
        let isProcessing = false;
        
        // Initialize WebSocket connection
         function initializeSocket() {
             socket = io();
             
             // Listen for agent status updates
             socket.on('agent_status', function(data) {
                 updateAgentStatus(data);
             });
             
             socket.on('agent1_status', function(data) {
                 updateAgent1Status(data);
             });
             
             socket.on('agent2_status', function(data) {
                 updateAgent2Status(data);
             });
             
             // Listen for specific output events
             socket.on('segments_generated', function(data) {
                 console.log('segments_generated event received:', data);
                 displaySegments(data.segments);
                 if (data.segments && data.segments.length > 0) {
                     addThinkingEntry('Agent 1', `Generated ${data.segments.length} customer segments`);
                 } else {
                     addThinkingEntry('Agent 1', 'Segments generation completed but no data received');
                 }
             });
             
             socket.on('goals_generated', function(data) {
                 displayGoals(data.goals);
                 addThinkingEntry('Agent 1', `Generated ${data.goals.length} business goals for approval`);
             });
             
             socket.on('campaigns_generated', function(data) {
                 console.log('Received campaigns_generated event:', data);
                 displayCampaigns(data.campaigns);
                 addThinkingEntry('Agent 1', `Generated ${data.campaigns.length} marketing campaigns for review`);
                 
                 // Also populate results section with campaign data
                 const resultsData = {
                     agent1_result: {
                         campaigns: data.campaigns,
                         segments: [], // Will be populated when available
                         business_goals: [] // Will be populated when available
                     },
                     agent2_result: null
                 };
                 displayResults(resultsData);
                 document.getElementById('results-section').style.display = 'block';
             });
             
             socket.on('implementation_ready', function(data) {
                 displayImplementation(data.implementation);
                 addThinkingEntry('Agent 2', 'Implementation plan ready');
                 
                 // Display Agent 1's campaigns with Agent 2's analysis in Marketing Campaigns section
                 if (data.agent1_result && data.agent1_result.marketing_campaigns) {
                     console.log('Displaying campaigns with Agent 2 analysis:', data.agent1_result.marketing_campaigns);
                     displayCampaignsForReview(data.agent1_result.marketing_campaigns);
                 } else if (data.agent1_result && data.agent1_result.campaigns) {
                     console.log('Displaying campaigns with Agent 2 analysis:', data.agent1_result.campaigns);
                     displayCampaignsForReview(data.agent1_result.campaigns);
                 }
                 
                 // Update results section with complete data from both agents
                 displayResults(data);
                 document.getElementById('results-section').style.display = 'block';
             });
             
             // Listen for approval responses
             socket.on('approval_received', function(data) {
                 addThinkingEntry('System', `Approval received: ${data.message}`);
                 showAlert(data.message, 'success');
             });
             
             socket.on('goals_approval_success', function(data) {
                 console.log('Goals approval success:', data);
                 showApprovalSuccessAnimation();
                 addThinkingEntry('System', 'Business goals approved successfully - generating campaigns...');
             });
             
             socket.on('modification_requested', function(data) {
                addThinkingEntry('System', `Modification requested: ${data.feedback}`);
                showAlert('Modification request sent to agent', 'info');
            });
            
            socket.on('goal_updated', function(data) {
                console.log('Goal updated:', data);
                const goalIndex = data.goal_index;
                const updatedGoal = data.updated_goal;
                
                // Update the goal display in the UI
                const goalElement = document.getElementById(`goal-${goalIndex}`);
                if (goalElement) {
                    updateGoalDisplay(goalElement, updatedGoal, goalIndex);
                }
                
                addThinkingEntry('System', `Goal ${goalIndex + 1} updated successfully`);
                showAlert(`Goal "${updatedGoal.name}" updated successfully`, 'success');
            });
            
            socket.on('goal_deleted', function(data) {
                console.log('Goal deleted:', data);
                const goalIndex = data.goal_index;
                
                // Remove the goal from display
                const goalElement = document.getElementById(`goal-${goalIndex}`);
                if (goalElement) {
                    goalElement.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => {
                        goalElement.remove();
                        refreshGoalSelects();
                    }, 300);
                }
                
                addThinkingEntry('System', data.message || `Goal ${goalIndex + 1} deleted`);
                showAlert(data.message || 'Goal deleted successfully', 'success');
            });
            
            socket.on('modification_completed', function(data) {
                console.log('Modification completed:', data);
                addThinkingEntry('System', data.message || 'Goal modification completed');
            });
            
            socket.on('campaigns_approved_and_stored', function(data) {
                console.log('Campaigns approved and stored:', data);
                if (data.campaigns && data.campaigns.length > 0) {
                    // Store campaigns for review in Marketing Campaigns section
                    agentGeneratedCampaigns = data.campaigns;
                    
                    // Display campaigns in Marketing Campaigns section for review and selection
                    displayCampaignsForReview(data.campaigns);
                    
                    // Also add approved campaigns to the All Campaigns section
                    addApprovedCampaignsToAllSection(data.campaigns);
                    
                    addThinkingEntry('System', data.message || `${data.campaigns.length} campaigns ready for review and added to all campaigns`);
                    
                    // Show success notification
                    showAlert(data.message || 'Campaigns are ready for review and added to All Campaigns section!', 'success');
                }
            });
            
            socket.on('connect', function() {
                console.log('Connected to server');
                addThinkingEntry('System', 'Connected to real-time agent monitoring');
            });
             
             socket.on('disconnect', function() {
                 console.log('Disconnected from server');
                 addThinkingEntry('System', 'Disconnected from server');
             });
         }
        
        // Show approval success animation
        function showApprovalSuccessAnimation() {
            // Create approval success overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-in;
            `;
            
            const successBox = document.createElement('div');
            successBox.style.cssText = `
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
                padding: 40px;
                border-radius: 20px;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                animation: bounceIn 0.6s ease-out;
                max-width: 400px;
            `;
            
            successBox.innerHTML = `
                <div style="font-size: 60px; margin-bottom: 20px;">✅</div>
                <h2 style="margin: 0 0 10px 0; font-size: 28px;">Approval Successful!</h2>
                <p style="margin: 0; font-size: 16px; opacity: 0.9;">Business goals approved. Generating campaigns...</p>
            `;
            
            overlay.appendChild(successBox);
            document.body.appendChild(overlay);
            
            // Add CSS animations if not already present
            if (!document.getElementById('approval-animations')) {
                const style = document.createElement('style');
                style.id = 'approval-animations';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes bounceIn {
                        0% { transform: scale(0.3); opacity: 0; }
                        50% { transform: scale(1.05); }
                        70% { transform: scale(0.9); }
                        100% { transform: scale(1); opacity: 1; }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Remove overlay after 3 seconds
            setTimeout(() => {
                overlay.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                }, 300);
            }, 3000);
        }
        
        // Show campaign approval success animation
        function showCampaignApprovalSuccessAnimation() {
            // Create approval success overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-in;
            `;
            
            const successBox = document.createElement('div');
            successBox.style.cssText = `
                background: linear-gradient(135deg, #2196F3, #1976D2);
                color: white;
                padding: 40px;
                border-radius: 20px;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                animation: bounceIn 0.6s ease-out;
                max-width: 400px;
            `;
            
            successBox.innerHTML = `
                <div style="font-size: 60px; margin-bottom: 20px;">🚀</div>
                <h2 style="margin: 0 0 10px 0; font-size: 28px;">Campaigns Approved!</h2>
                <p style="margin: 0; font-size: 16px; opacity: 0.9;">All campaigns approved and moved to management!</p>
            `;
            
            overlay.appendChild(successBox);
            document.body.appendChild(overlay);
            
            // Add CSS animations if not already present
            if (!document.getElementById('approval-animations')) {
                const style = document.createElement('style');
                style.id = 'approval-animations';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes bounceIn {
                        0% { transform: scale(0.3); opacity: 0; }
                        50% { transform: scale(1.05); }
                        70% { transform: scale(0.9); }
                        100% { transform: scale(1); opacity: 1; }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Remove overlay after 3 seconds
            setTimeout(() => {
                overlay.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                }, 300);
            }, 3000);
        }
        
        // Update overall agent status
        function updateAgentStatus(data) {
            const statusContainer = document.getElementById('agent-status-container');
            const processBtn = document.getElementById('process-btn');
            const stopBtn = document.getElementById('stop-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            
            switch(data.status) {
                case 'starting':
                case 'initializing':
                    statusContainer.style.display = 'block';
                    processBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    loadingSpinner.style.display = 'block';
                    isProcessing = true;
                    showAlert(data.message, 'info');
                    break;
                    
                case 'agent1_thinking':
                    updateAgent1UI('thinking', data.message, data.step);
                    break;
                    
                case 'agent1_complete':
                    updateAgent1UI('completed', data.message);
                    break;
                    
                case 'agent2_thinking':
                    updateAgent2UI('thinking', data.message, data.step);
                    break;
                    
                case 'completed':
                    statusContainer.style.display = 'none';
                    processBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    loadingSpinner.style.display = 'none';
                    isProcessing = false;
                    showAlert(data.message, 'success');
                    displayResults(data);
                    document.getElementById('results-section').style.display = 'block';
                    updateStats();
                    break;
                    
                case 'error':
                    statusContainer.style.display = 'none';
                    processBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    loadingSpinner.style.display = 'none';
                    isProcessing = false;
                    showAlert(data.message, 'danger');
                    break;
            }
        }
        
        // Update Agent 1 specific status
         function updateAgent1Status(data) {
             const statusText = document.getElementById('agent1-status-text');
             const spinner = document.getElementById('agent1-spinner');
             const statusIcon = document.getElementById('agent1-status-icon');
             const progressBar = document.getElementById('agent1-progress-bar');
             const stepElement = document.getElementById('agent1-step');
             const detailsElement = document.getElementById('agent1-details');
             const approvalSection = document.getElementById('approval-section');
             
             statusText.textContent = data.message;
             
             // Add thinking entry for all status updates
             addThinkingEntry('Agent 1', data.message);
             
             switch(data.status) {
                 case 'thinking':
                     spinner.style.display = 'inline-block';
                     statusIcon.className = 'fas fa-brain text-white';
                        statusIcon.style.color = '';
                     progressBar.style.width = '25%';
                     if (data.step) {
                         stepElement.textContent = data.step.replace('_', ' ');
                         detailsElement.style.display = 'block';
                     }
                     break;
                     
                 case 'progress':
                     progressBar.style.width = '50%';
                     // Display generated content based on step
                     if (data.step === 'segmentation' && data.data) {
                         displaySegments(data.data);
                     }
                     break;
                     
                 case 'waiting_approval':
                     spinner.style.display = 'none';
                     statusIcon.className = 'fas fa-user-check text-warning';
                     progressBar.style.width = '75%';
                     showApprovalSection(data.message, data.data);
                     // Display goals for approval
                     if (data.step === 'goal_approval' && data.data) {
                         displayGoals(data.data);
                     }
                     break;
                     
                 case 'approved':
                     hideApprovalSection();
                     statusIcon.className = 'fas fa-check text-success';
                     break;
                     
                 case 'waiting_review':
                     spinner.style.display = 'none';
                     statusIcon.className = 'fas fa-eye text-info';
                     showApprovalSection(data.message, data.data);
                     // Display campaigns for review
                     if (data.step === 'campaign_review' && data.data) {
                         displayCampaigns(data.data);
                     }
                     break;
                     
                 case 'reviewed':
                     hideApprovalSection();
                     statusIcon.className = 'fas fa-check text-success';
                     break;
                     
                 case 'completed':
                     spinner.style.display = 'none';
                     statusIcon.className = 'fas fa-check-circle text-success';
                     progressBar.style.width = '100%';
                     break;
                     
                 case 'error':
                     spinner.style.display = 'none';
                     statusIcon.className = 'fas fa-exclamation-triangle text-danger';
                     break;
             }
         }
        
        // Update Agent 2 specific status
         function updateAgent2Status(data) {
             const statusText = document.getElementById('agent2-status-text');
             const spinner = document.getElementById('agent2-spinner');
             const statusIcon = document.getElementById('agent2-status-icon');
             const progressBar = document.getElementById('agent2-progress-bar');
             
             statusText.textContent = data.message;
             
             // Add thinking entry for Agent 2
             addThinkingEntry('Agent 2', data.message);
             
             switch(data.status) {
                 case 'thinking':
                     spinner.style.display = 'inline-block';
                     statusIcon.className = 'fas fa-cogs text-secondary';
                     progressBar.style.width = '50%';
                     break;
                     
                 case 'progress':
                     progressBar.style.width = '75%';
                     // Display implementation plans if available
                     if (data.data && data.data.implementation) {
                         displayImplementation(data.data.implementation);
                     }
                     break;
                     
                 case 'completed':
                     spinner.style.display = 'none';
                     statusIcon.className = 'fas fa-check-circle text-success';
                     progressBar.style.width = '100%';
                     // Display final implementation if available
                     if (data.data && data.data.implementation) {
                         displayImplementation(data.data.implementation);
                     }
                     break;
             }
         }
        
        // Show approval section
        function showApprovalSection(message, data) {
            const approvalSection = document.getElementById('approval-section');
            const approvalMessage = document.getElementById('approval-message');
            const approvalData = document.getElementById('approval-data');
            
            approvalSection.style.display = 'block';
            approvalMessage.textContent = message;
            
            if (data && Array.isArray(data)) {
                approvalData.innerHTML = '<strong>Items:</strong> ' + data.join(', ');
                approvalData.style.display = 'block';
            }
        }
        
        // Hide approval section
        function hideApprovalSection() {
            const approvalSection = document.getElementById('approval-section');
            approvalSection.style.display = 'none';
        }
        
        // Update Agent UI helper functions
        function updateAgent1UI(status, message, step) {
            updateAgent1Status({status, message, step});
        }
        
        function updateAgent2UI(status, message, step) {
            updateAgent2Status({status, message, step});
        }
        
        // Stop processing function
        function stopProcessing() {
            if (socket && isProcessing) {
                socket.emit('stop_processing');
                showAlert('Processing stopped by user', 'warning');
                resetProcessingUI();
            }
        }
        
        // Reset processing UI
        function resetProcessingUI() {
            const statusContainer = document.getElementById('agent-status-container');
            const processBtn = document.getElementById('process-btn');
            const stopBtn = document.getElementById('stop-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            
            statusContainer.style.display = 'none';
            processBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            loadingSpinner.style.display = 'none';
            isProcessing = false;
            hideApprovalSection();
        }
        
        // Initialize socket when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
        });
        
        // Functions for handling agent outputs
        function displaySegments(segments) {
            console.log('displaySegments called with:', segments);
            const segmentsSection = document.getElementById('segments-section');
            const segmentsContent = document.getElementById('segments-content');
            
            if (!segments || segments.length === 0) {
                console.log('No segments data received');
                segmentsContent.innerHTML = '<p class="text-muted">No customer segments generated yet.</p>';
                return;
            }
            
            let html = '';
            segments.forEach((segment, index) => {
                // Handle characteristics - could be array or object
                let characteristicsText = '';
                if (segment.characteristics) {
                    if (Array.isArray(segment.characteristics)) {
                        characteristicsText = segment.characteristics.join(', ');
                    } else if (typeof segment.characteristics === 'object') {
                        characteristicsText = Object.values(segment.characteristics).join(', ');
                    } else {
                        characteristicsText = segment.characteristics.toString();
                    }
                }
                
                // Handle size - could be size_estimate or size
                const size = segment.size_estimate || segment.size || 'Not specified';
                
                html += `
                    <div class="segment-card mb-3 p-3 border rounded">
                        <div class="segment-header h6 text-primary">Segment ${index + 1}: ${segment.name}</div>
                        <p><strong>Description:</strong> ${segment.description || 'No description available'}</p>
                        <p><strong>Size:</strong> ${size}</p>
                        <p><strong>Characteristics:</strong> ${characteristicsText || 'No characteristics specified'}</p>
                        ${segment.priority_score ? `<p><strong>Priority Score:</strong> ${segment.priority_score}/10</p>` : ''}
                    </div>
                `;
            });
            
            segmentsContent.innerHTML = html;
            segmentsSection.style.display = 'block';
            document.getElementById('agent-output-section').style.display = 'block';
        }
        
        function displayGoals(goals) {
            const goalsSection = document.getElementById('goals-section');
            const goalsContent = document.getElementById('goals-content');
            
            // Store goals globally for management functions
            window.currentGoals = goals;
            
            // Initialize approved goals tracking if not exists
            if (!window.approvedGoals) {
                window.approvedGoals = new Set();
            }
            
            let html = '';
            goals.forEach((goal, index) => {
                const isApproved = window.approvedGoals.has(index);
                const approvedBadge = isApproved ? '<span class="badge bg-success ms-2"><i class="fas fa-check"></i> Approved</span>' : '';
                const goalClass = isApproved ? 'goal-item approved-goal' : 'goal-item';
                
                html += `
                    <div class="${goalClass}" id="goal-${index}">
                        <strong>Goal ${index + 1}:</strong> ${goal.name || goal.title || 'Unnamed Goal'}${approvedBadge}<br>
                        <small class="text-muted">${goal.description}</small>
                    </div>
                `;
            });
            
            goalsContent.innerHTML = html;
            
            // Populate checkboxes for goal selection
            const checkboxContainer = document.getElementById('goal-checkboxes');
            let checkboxHtml = '';
            goals.forEach((goal, index) => {
                checkboxHtml += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${index}" id="goal-check-${index}">
                        <label class="form-check-label" for="goal-check-${index}">
                            Goal ${index + 1}: ${goal.name || goal.title || 'Unnamed Goal'}
                        </label>
                    </div>
                `;
            });
            checkboxContainer.innerHTML = checkboxHtml;
            
            // Populate dropdown menus
            const editSelect = document.getElementById('goal-edit-select');
            const rejectSelect = document.getElementById('goal-reject-select');
            
            let optionHtml = '<option value="">Select a goal...</option>';
            goals.forEach((goal, index) => {
                optionHtml += `<option value="${index}">Goal ${index + 1}: ${goal.name || goal.title || 'Unnamed Goal'}</option>`;
            });
            
            editSelect.innerHTML = optionHtml.replace('Select a goal...', 'Select a goal to edit...');
            rejectSelect.innerHTML = optionHtml.replace('Select a goal...', 'Select a goal to reject...');
            
            // Add event listener for edit select
            editSelect.addEventListener('change', showGoalEditForm);
            
            goalsSection.style.display = 'block';
            document.getElementById('goals-approval').style.display = 'block';
            document.getElementById('agent-output-section').style.display = 'block';
        }
        
        function displayCampaigns(agentCampaigns) {
            console.log('Displaying campaigns for review:', agentCampaigns);
            
            if (!agentCampaigns || agentCampaigns.length === 0) {
                console.log('No campaigns data available');
                return;
            }
            
            // Store agent campaigns for review (do not auto-convert to management format)
            agentGeneratedCampaigns = agentCampaigns;
            
            // Only display in the Marketing Campaigns section for review and selection
            displayCampaignsForReview(agentCampaigns);
            
            console.log(`✅ ${agentCampaigns.length} campaigns loaded in Marketing Campaigns section for review`);
        }
        
        function displayCampaignsForReview(campaigns) {
            // Store campaigns in global variable for CRUD operations
            agentGeneratedCampaigns = campaigns;
            
            const campaignsSection = document.getElementById('campaigns-section');
            const campaignsContent = document.getElementById('campaigns-content');
            
            if (!campaignsContent) return;
            
            // Show the campaigns section and add header for generated campaigns
            campaignsSection.style.display = 'block';
            
            let html = '<div class="alert alert-success mb-3"><strong><i class="fas fa-magic me-2"></i>Generated Campaigns Ready for Review</strong><br>Review, select, and approve campaigns below. Only selected campaigns will appear in All Campaigns section.</div>';
            
            // Add selection and approval controls at the top
            html += `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <h6 class="mb-0 text-primary me-3"><i class="fas fa-list me-2"></i>Generated Marketing Campaigns (${campaigns.length})</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="select-all-marketing-campaigns" onchange="toggleAllMarketingCampaigns()">
                            <label class="form-check-label" for="select-all-marketing-campaigns">Select All</label>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="approveSelectedCampaigns()">
                            <i class="fas fa-check me-1"></i>Approve Selected
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="modifyCampaigns()">
                            <i class="fas fa-edit me-1"></i>Request Changes
                        </button>
                    </div>
                </div>
            `;
            
            let campaignCardsHtml = '';
            campaigns.forEach((campaign, index) => {
                // Handle target_segments array
                const targets = Array.isArray(campaign.target_segments) ? campaign.target_segments.join(', ') : (campaign.target || 'Not specified');
                
                // Handle channels array
                const channels = Array.isArray(campaign.channels) ? campaign.channels.join(', ') : (campaign.channel || 'Not specified');
                
                // Handle business_goals array
                const goals = Array.isArray(campaign.business_goals) ? campaign.business_goals.join(', ') : 'Not specified';
                
                // Handle budget
                const budget = campaign.budget_estimate || campaign.budget || 'Not specified';
                
                // Handle timeline
                const timeline = campaign.timeline || campaign.duration || 'Not specified';
                
                campaignCardsHtml += `
                    <div class="campaign-card border rounded p-3 mb-3" data-campaign-index="${index}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <div class="form-check me-3">
                                    <input class="form-check-input marketing-campaign-checkbox" type="checkbox" value="${index}" id="marketing-campaign-${index}">
                                    <label class="form-check-label" for="marketing-campaign-${index}"></label>
                                </div>
                                <div class="campaign-header h5 mb-0">${campaign.name || 'Unnamed Campaign'}</div>
                            </div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="editGeneratedCampaign(${index})" title="Edit Campaign">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteGeneratedCampaign(${index})" title="Delete Campaign">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div id="campaign-view-${index}">
                            <p><strong>Description:</strong> ${campaign.description || 'No description'}</p>
                            <p><strong>Target Segments:</strong> ${targets}</p>
                            <p><strong>Channels:</strong> ${channels}</p>
                            <p><strong>Business Goals:</strong> ${goals}</p>
                            <p><strong>Budget:</strong> ${budget}</p>
                            <p><strong>Timeline:</strong> ${timeline}</p>
                            ${campaign.success_metrics && campaign.success_metrics.length > 0 ? `<p><strong>Success Metrics:</strong> ${campaign.success_metrics.join(', ')}</p>` : ''}
                        </div>
                        <div id="campaign-edit-${index}" style="display: none;">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Campaign Name</label>
                                    <input type="text" class="form-control" id="edit-name-${index}" value="${campaign.name || ''}">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="edit-description-${index}" rows="3">${campaign.description || ''}</textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Target Segments</label>
                                    <input type="text" class="form-control" id="edit-targets-${index}" value="${targets}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Channels</label>
                                    <input type="text" class="form-control" id="edit-channels-${index}" value="${channels}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Budget</label>
                                    <input type="text" class="form-control" id="edit-budget-${index}" value="${budget}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Timeline</label>
                                    <input type="text" class="form-control" id="edit-timeline-${index}" value="${timeline}">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Business Goals</label>
                                    <input type="text" class="form-control" id="edit-goals-${index}" value="${goals}">
                                </div>
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-success" onclick="saveGeneratedCampaign(${index})">
                                            <i class="fas fa-save me-1"></i>Save Changes
                                        </button>
                                        <button class="btn btn-secondary" onclick="cancelEditGeneratedCampaign(${index})">
                                            <i class="fas fa-times me-1"></i>Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Combine header and campaign cards
            html += campaignCardsHtml;
            
            campaignsContent.innerHTML = html;
            if (campaignsSection) {
                campaignsSection.style.display = 'block';
            }
            
            // Hide the separate review section since campaigns are now shown directly in Marketing Campaign section
            const reviewSection = document.getElementById('campaigns-review');
            if (reviewSection) {
                reviewSection.style.display = 'none';
            }
            
            const outputSection = document.getElementById('agent-output-section');
            if (outputSection) {
                outputSection.style.display = 'block';
            }
        }
        
        function convertAgentCampaignsToManagementFormat(agentCampaigns) {
            return agentCampaigns.map(campaign => {
                const budget = parseFloat(campaign.budget_estimate?.toString().replace(/[^\d.]/g, '')) || 5000;
                const channels = Array.isArray(campaign.channels) ? campaign.channels : [];
                const primaryChannel = channels[0] || 'Multi-channel';
                
                return {
                    id: campaignIdCounter++,
                    name: campaign.name || 'Unnamed Campaign',
                    type: primaryChannel.charAt(0).toUpperCase() + primaryChannel.slice(1),
                    status: 'Draft', // New campaigns start as draft
                    segment: Array.isArray(campaign.target_segments) ? campaign.target_segments.join(', ') : 'General',
                    budget: budget,
                    spent: 0, // New campaigns haven't spent anything yet
                    impressions: 0,
                    clicks: 0,
                    conversions: 0,
                    created: new Date().toISOString().split('T')[0],
                    lastModified: new Date().toISOString().split('T')[0],
                    // Store original agent data
                    agentData: campaign
                };
            });
        }
        
        function displayImplementation(implementation) {
            const implementationContent = document.getElementById('implementation-content');
            
            let html = `
                <div class="structured-implementation-plan">
                    <!-- Decision Flow Analysis Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-sitemap me-2"></i>AI Decision Flow Analysis</h6>
                        </div>
                        <div class="card-body">
            `;
            
            // Handle decision flows for different segments
            if (implementation.decision_flows) {
                html += `<div class="row">`;
                Object.entries(implementation.decision_flows).forEach(([segment, flow], index) => {
                    const colClass = Object.keys(implementation.decision_flows).length === 1 ? 'col-12' : 'col-md-6';
                    html += `
                        <div class="${colClass} mb-3">
                            <div class="card border-info h-100">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-users me-2"></i>${segment.replace('_', ' ').toUpperCase()}</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-bullseye text-primary me-2"></i>
                                            <strong>Goal:</strong>
                                        </div>
                                        <p class="ms-4 mb-0">${flow.goal}</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-filter text-warning me-2"></i>
                                            <strong>Criteria:</strong>
                                        </div>
                                        <p class="ms-4 mb-0">${flow.criteria}</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-rocket text-success me-2"></i>
                                            <strong>Actions:</strong>
                                        </div>
                                        <ul class="list-group list-group-flush ms-3">
                    `;
                    
                    flow.actions.forEach(action => {
                        html += `<li class="list-group-item border-0 px-0 py-1"><i class="fas fa-chevron-right text-muted me-2"></i>${action}</li>`;
                    });
                    
                    html += `
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-brain text-info me-2"></i>
                                            <strong>Context Factors:</strong>
                                        </div>
                                        <ul class="list-group list-group-flush ms-3">
                    `;
                    
                    flow.context_factors.forEach(factor => {
                        html += `<li class="list-group-item border-0 px-0 py-1"><i class="fas fa-dot-circle text-muted me-2"></i>${factor}</li>`;
                    });
                    
                    html += `
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-chart-line text-success me-2"></i>
                                            <strong>Success Metrics:</strong>
                                        </div>
                                        <ul class="list-group list-group-flush ms-3">
                    `;
                    
                    flow.success_metrics.forEach(metric => {
                        html += `<li class="list-group-item border-0 px-0 py-1"><i class="fas fa-chart-bar text-muted me-2"></i>${metric}</li>`;
                    });
                    
                    html += `</ul></div>`;
                    
                    // Show Agent 1 integration details if available
                    if (flow.segment_details || flow.relevant_campaigns !== undefined || flow.channels) {
                        html += `
                                    <div class="mt-3 p-3 bg-light rounded">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-link text-primary me-2"></i>
                                            <strong>Agent Integration:</strong>
                                        </div>
                                        <div class="d-flex flex-wrap gap-2">`;
                        
                        if (flow.segment_details && flow.segment_details.size) {
                            html += `<span class="badge bg-info"><i class="fas fa-users me-1"></i>${flow.segment_details.size} customers</span>`;
                        }
                        
                        if (flow.relevant_campaigns !== undefined) {
                            html += `<span class="badge bg-success"><i class="fas fa-envelope me-1"></i>${flow.relevant_campaigns} campaigns</span>`;
                        }
                        
                        if (flow.relevant_goals !== undefined) {
                            html += `<span class="badge bg-warning"><i class="fas fa-bullseye me-1"></i>${flow.relevant_goals} goals</span>`;
                        }
                        
                        if (flow.channels && flow.channels.length > 0) {
                            html += `<span class="badge bg-secondary"><i class="fas fa-broadcast-tower me-1"></i>${flow.channels.join(', ')}</span>`;
                        }
                        
                        if (flow.segment_details && flow.segment_details.priority_score) {
                            html += `<span class="badge bg-primary"><i class="fas fa-star me-1"></i>Priority: ${flow.segment_details.priority_score}</span>`;
                        }
                        
                        html += `
                                        </div>
                                    </div>`;
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            html += `
                        </div>
                    </div>
                    
                    <!-- AI Execution Strategy Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>AI Execution Strategy</h6>
                        </div>
                        <div class="card-body">
            `;
            
            // Handle AI execution strategy
            if (implementation.ai_execution_strategy) {
                const strategy = implementation.ai_execution_strategy;
                
                html += `
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-sync-alt text-success me-2"></i>
                                                <strong>Real-time Decisioning</strong>
                                            </div>
                                            <p class="mb-0 text-muted">${strategy.real_time_decisioning}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-palette text-success me-2"></i>
                                                <strong>Personalization Engine</strong>
                                            </div>
                                            <p class="mb-0 text-muted">${strategy.personalization_engine}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-chart-line text-success me-2"></i>
                                                <strong>Value Prediction</strong>
                                            </div>
                                            <p class="mb-0 text-muted">${strategy.value_prediction}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-brain text-success me-2"></i>
                                                <strong>Learning System</strong>
                                            </div>
                                            <p class="mb-0 text-muted">${strategy.learning_system}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                `;
            } else {
                html += `
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-sync-alt text-success me-2"></i>
                                                <strong>Real-time Decisioning</strong>
                                            </div>
                                            <p class="mb-0 text-muted">Dynamic customer journey optimization based on real-time behavior analysis and predictive modeling.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-palette text-success me-2"></i>
                                                <strong>Personalization Engine</strong>
                                            </div>
                                            <p class="mb-0 text-muted">Advanced ML algorithms for content, timing, and channel personalization at individual customer level.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-dollar-sign text-success me-2"></i>
                                                <strong>Value Prediction</strong>
                                            </div>
                                            <p class="mb-0 text-muted">Predictive analytics for customer lifetime value and conversion probability scoring.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-brain text-success me-2"></i>
                                                <strong>Learning System</strong>
                                            </div>
                                            <p class="mb-0 text-muted">Continuous model improvement through feedback loops and A/B testing integration.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                `;
            }
            
            html += `
                        </div>
                    </div>
                    
                    <!-- Performance Tracking Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Performance Tracking</h6>
                        </div>
                        <div class="card-body">
            `;
            
            // Handle performance tracking
            if (implementation.performance_tracking) {
                const tracking = implementation.performance_tracking;
                
                html += `
                            <div class="row">
                                <div class="col-lg-4 mb-3">
                                    <div class="card border-warning h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Real-time Metrics</h6>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled mb-0">
                `;
                
                tracking.real_time_metrics.forEach(metric => {
                    html += `<li class="mb-2"><i class="fas fa-chart-line text-primary me-2"></i>${metric}</li>`;
                });
                
                html += `
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-3">
                                    <div class="card border-warning h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-flask me-2"></i>A/B Testing</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-0">${tracking.ab_testing}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-3">
                                    <div class="card border-warning h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-wrench me-2"></i>Optimization</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-0">${tracking.optimization}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                `;
            } else {
                html += `
                            <div class="row">
                                <div class="col-lg-4 mb-3">
                                    <div class="card border-warning h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Real-time Metrics</h6>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled mb-0">
                                                <li class="mb-2"><i class="fas fa-arrow-up text-success me-2"></i>Conversion rates by segment and channel</li>
                                                <li class="mb-2"><i class="fas fa-heart text-danger me-2"></i>Customer engagement scores</li>
                                                <li class="mb-2"><i class="fas fa-money-bill-wave text-success me-2"></i>Revenue attribution tracking</li>
                                                <li class="mb-0"><i class="fas fa-bullhorn text-primary me-2"></i>Campaign performance indicators</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-3">
                                    <div class="card border-warning h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-flask me-2"></i>A/B Testing</h6>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled mb-0">
                                                <li class="mb-2"><i class="fas fa-plus-circle text-success me-2"></i>Automated test creation and management</li>
                                                <li class="mb-2"><i class="fas fa-chart-line text-info me-2"></i>Statistical significance monitoring</li>
                                                <li class="mb-0"><i class="fas fa-trophy text-warning me-2"></i>Winner selection and deployment</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-3">
                                    <div class="card border-warning h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-wrench me-2"></i>Optimization</h6>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled mb-0">
                                                <li class="mb-2"><i class="fas fa-cog text-secondary me-2"></i>Continuous model refinement</li>
                                                <li class="mb-2"><i class="fas fa-exclamation-triangle text-danger me-2"></i>Performance anomaly detection</li>
                                                <li class="mb-0"><i class="fas fa-adjust text-primary me-2"></i>Automated strategy adjustments</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                `;
            }
            
            html += `
                        </div>
                    </div>
            `;
            
            // Fallback for legacy implementation plan format
            if (!implementation.decision_flows && implementation.timeline) {
                html += `
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Implementation Timeline</h6>
                        </div>
                        <div class="card-body">
                            <div class="timeline-content">
                `;
                
                if (Array.isArray(implementation.timeline)) {
                    implementation.timeline.forEach((item, index) => {
                        html += `
                            <div class="card mb-3 border-secondary">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-secondary me-2">${index + 1}</span>
                                        <strong>${item.phase}</strong>
                                        ${item.duration ? `<span class="badge bg-info ms-auto">${item.duration}</span>` : ''}
                                    </div>
                                    <p class="mb-0 text-muted">${item.description}</p>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    let index = 0;
                    Object.entries(implementation.timeline).forEach(([phase, description]) => {
                        html += `
                            <div class="card mb-3 border-secondary">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-secondary me-2">${++index}</span>
                                        <strong>${phase}</strong>
                                    </div>
                                    <p class="mb-0 text-muted">${description}</p>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += `
                </div>
            `;
            
            implementationContent.innerHTML = html;
            document.getElementById('agent2-output').style.display = 'block';
            document.getElementById('agent-output-section').style.display = 'block';
        }
        
        function addThinkingEntry(agent, message) {
            const thinkingLog = document.getElementById('thinking-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const entry = document.createElement('div');
            entry.className = 'thinking-entry';
            entry.innerHTML = `
                <div class="thinking-timestamp">${timestamp} - ${agent}</div>
                <div>${message}</div>
            `;
            
            thinkingLog.appendChild(entry);
            thinkingLog.scrollTop = thinkingLog.scrollHeight;
            document.getElementById('agent-output-section').style.display = 'block';
        }
        
        // Approval functions
        function approveGoals() {
            if (socket) {
                socket.emit('approve_goals');
                document.getElementById('goals-approval').style.display = 'none';
                showAlert('Goals approved successfully!', 'success');
            }
        }
        
        function modifyGoals() {
            const feedback = prompt('Please provide feedback for goal modifications:');
            if (feedback && socket) {
                socket.emit('modify_goals', {feedback: feedback});
                document.getElementById('goals-approval').style.display = 'none';
                showAlert('Modification request sent to agent', 'info');
            }
        }
        
        // New interactive goal management functions
        function approveSelectedGoals() {
            const selectedGoals = [];
            const checkboxes = document.querySelectorAll('#goal-checkboxes input[type="checkbox"]:checked');
            
            checkboxes.forEach(checkbox => {
                selectedGoals.push(parseInt(checkbox.value));
            });
            
            if (selectedGoals.length === 0) {
                showAlert('Please select at least one goal to approve', 'warning');
                return;
            }
            
            if (socket) {
                socket.emit('approve_selected_goals', {goal_indices: selectedGoals});
                showAlert(`Approved ${selectedGoals.length} selected goals`, 'success');
                
                // Mark goals as approved visually
                selectedGoals.forEach(index => {
                    window.approvedGoals.add(index);
                    const goalElement = document.getElementById(`goal-${index}`);
                    if (goalElement) {
                        goalElement.className = 'goal-item approved-goal';
                        const titleElement = goalElement.querySelector('strong');
                        if (titleElement && !titleElement.querySelector('.badge')) {
                            titleElement.innerHTML += '<span class="badge bg-success ms-2"><i class="fas fa-check"></i> Approved</span>';
                        }
                    }
                });
            }
        }
        
        function approveAllGoals() {
            if (socket && window.currentGoals) {
                // Use the dedicated approve_goals event for approving all goals
                socket.emit('approve_goals');
                
                // Mark all goals as approved visually
                const allIndices = window.currentGoals.map((_, index) => index);
                allIndices.forEach(index => {
                    window.approvedGoals.add(index);
                    const goalElement = document.getElementById(`goal-${index}`);
                    if (goalElement) {
                        goalElement.className = 'goal-item approved-goal';
                        const titleElement = goalElement.querySelector('strong');
                        if (titleElement && !titleElement.querySelector('.badge')) {
                            titleElement.innerHTML += '<span class="badge bg-success ms-2"><i class="fas fa-check"></i> Approved</span>';
                        }
                    }
                });
                
                document.getElementById('goals-approval').style.display = 'none';
                showAlert('All goals approved successfully!', 'success');
            }
        }
        
        let currentEditingGoalIndex = null;
        
        function showGoalEditForm() {
            const selectedIndex = document.getElementById('goal-edit-select').value;
            const editForm = document.getElementById('goal-edit-form');
            
            if (!selectedIndex) {
                editForm.style.display = 'none';
                currentEditingGoalIndex = null;
                return;
            }
            
            currentEditingGoalIndex = parseInt(selectedIndex);
            
            // Get goal data from the displayed goals
            const goalElement = document.getElementById(`goal-${selectedIndex}`);
            if (goalElement) {
                // Extract current goal data and populate form
                const goalData = extractGoalData(goalElement);
                populateEditForm(goalData);
                editForm.style.display = 'block';
            }
        }
        
        function extractGoalData(goalElement) {
            // Extract goal data from the DOM element
            const nameElement = goalElement.querySelector('.goal-name') || goalElement.querySelector('strong');
            const descElement = goalElement.querySelector('.goal-description');
            const priorityElement = goalElement.querySelector('.goal-priority');
            
            return {
                name: nameElement ? nameElement.textContent.replace('Goal:', '').trim() : '',
                description: descElement ? descElement.textContent : goalElement.textContent.split('\n')[1] || '',
                priority: priorityElement ? priorityElement.textContent.toLowerCase() : 'medium',
                target_segments: [],
                success_metrics: [],
                timeline: ''
            };
        }
        
        function populateEditForm(goalData) {
            document.getElementById('edit-goal-name').value = goalData.name;
            document.getElementById('edit-goal-description').value = goalData.description;
            document.getElementById('edit-goal-priority').value = goalData.priority;
            document.getElementById('edit-goal-segments').value = Array.isArray(goalData.target_segments) ? goalData.target_segments.join(', ') : '';
            document.getElementById('edit-goal-metrics').value = Array.isArray(goalData.success_metrics) ? goalData.success_metrics.join(', ') : '';
            document.getElementById('edit-goal-timeline').value = goalData.timeline || '';
        }
        
        function saveGoalChanges() {
            if (currentEditingGoalIndex === null) {
                showAlert('No goal selected for editing', 'warning');
                return;
            }
            
            const updates = {
                name: document.getElementById('edit-goal-name').value.trim(),
                description: document.getElementById('edit-goal-description').value.trim(),
                priority: document.getElementById('edit-goal-priority').value,
                target_segments: document.getElementById('edit-goal-segments').value.trim(),
                success_metrics: document.getElementById('edit-goal-metrics').value.trim(),
                timeline: document.getElementById('edit-goal-timeline').value.trim()
            };
            
            // Validate required fields
            if (!updates.name || !updates.description) {
                showAlert('Goal name and description are required', 'warning');
                return;
            }
            
            if (socket) {
                // Send individual field updates
                Object.entries(updates).forEach(([field, value]) => {
                    if (value) {
                        socket.emit('modify_specific_goal', {
                            goal_index: currentEditingGoalIndex,
                            field: field,
                            new_value: value
                        });
                    }
                });
                
                showAlert('Goal updated successfully', 'success');
                cancelGoalEdit();
            }
        }
        
        function deleteGoal() {
            if (currentEditingGoalIndex === null) {
                showAlert('No goal selected for deletion', 'warning');
                return;
            }
            
            if (confirm('Are you sure you want to delete this goal? This action cannot be undone.')) {
                if (socket) {
                    socket.emit('delete_goal', {
                        goal_index: currentEditingGoalIndex
                    });
                    
                    showAlert('Goal deleted successfully', 'success');
                    cancelGoalEdit();
                }
            }
        }
        
        function cancelGoalEdit() {
            document.getElementById('goal-edit-form').style.display = 'none';
            document.getElementById('goal-edit-select').value = '';
            currentEditingGoalIndex = null;
            
            // Clear form fields
            document.getElementById('edit-goal-name').value = '';
            document.getElementById('edit-goal-description').value = '';
            document.getElementById('edit-goal-priority').value = 'medium';
            document.getElementById('edit-goal-segments').value = '';
            document.getElementById('edit-goal-metrics').value = '';
            document.getElementById('edit-goal-timeline').value = '';
        }
        

        
        function updateGoalDisplay(goalElement, updatedGoal, goalIndex) {
            // Update the goal display with new data
            const goalHtml = `
                <div class="goal-item" id="goal-${goalIndex}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong class="goal-name">Goal ${goalIndex + 1}: ${updatedGoal.name}</strong>
                            <p class="goal-description mb-1">${updatedGoal.description}</p>
                            <small class="text-muted">
                                <span class="goal-priority">Priority: ${updatedGoal.priority}</span>
                                ${updatedGoal.target_segments && updatedGoal.target_segments.length > 0 ? 
                                    ` | Segments: ${updatedGoal.target_segments.join(', ')}` : ''}
                                ${updatedGoal.success_metrics && updatedGoal.success_metrics.length > 0 ? 
                                    ` | Metrics: ${updatedGoal.success_metrics.join(', ')}` : ''}
                                ${updatedGoal.timeline ? ` | Timeline: ${updatedGoal.timeline}` : ''}
                            </small>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="goal-checkbox-${goalIndex}" value="${goalIndex}">
                            <label class="form-check-label" for="goal-checkbox-${goalIndex}"></label>
                        </div>
                    </div>
                </div>
            `;
            
            goalElement.outerHTML = goalHtml;
        }
        
        function refreshGoalSelects() {
            // Refresh the goal select dropdowns after deletion
            const editSelect = document.getElementById('goal-edit-select');
            const rejectSelect = document.getElementById('goal-reject-select');
            
            if (editSelect && rejectSelect) {
                // Get remaining goals
                const remainingGoals = document.querySelectorAll('.goal-item');
                
                // Clear and repopulate selects
                editSelect.innerHTML = '<option value="">Select a goal to edit...</option>';
                rejectSelect.innerHTML = '<option value="">Select a goal to reject...</option>';
                
                remainingGoals.forEach((goalElement, index) => {
                    const goalName = goalElement.querySelector('.goal-name');
                    if (goalName) {
                        const goalText = goalName.textContent;
                        
                        const editOption = document.createElement('option');
                        editOption.value = index;
                        editOption.textContent = goalText;
                        editSelect.appendChild(editOption);
                        
                        const rejectOption = document.createElement('option');
                        rejectOption.value = index;
                        rejectOption.textContent = goalText;
                        rejectSelect.appendChild(rejectOption);
                    }
                });
            }
        }
        
        function rejectSelectedGoal() {
            const selectedIndex = document.getElementById('goal-reject-select').value;
            
            if (!selectedIndex) {
                showAlert('Please select a goal to reject', 'warning');
                return;
            }
            
            if (socket) {
                socket.emit('reject_goal', {goal_index: parseInt(selectedIndex)});
                showAlert('Goal rejected', 'info');
                
                // Hide rejected goal
                const goalElement = document.getElementById(`goal-${selectedIndex}`);
                if (goalElement) {
                    goalElement.style.display = 'none';
                }
                
                // Reset dropdown
                document.getElementById('goal-reject-select').value = '';
            }
        }
        
        function addCustomGoal() {
            const title = document.getElementById('custom-goal-title').value;
            const description = document.getElementById('custom-goal-description').value;
            
            if (!title.trim() || !description.trim()) {
                showAlert('Please provide both title and description for the custom goal', 'warning');
                return;
            }
            
            if (socket) {
                socket.emit('add_custom_goal', {
                    title: title,
                    description: description
                });
                showAlert('Custom goal added successfully', 'success');
                
                // Add to current display
                const goalsContent = document.getElementById('goals-content');
                const newIndex = window.currentGoals ? window.currentGoals.length : 0;
                const newGoalHtml = `
                    <div class="goal-item" id="goal-${newIndex}" style="border-left: 3px solid #007bff;">
                        <strong>Goal ${newIndex + 1} (Custom):</strong> ${title}<br>
                        <small class="text-muted">${description}</small>
                    </div>
                `;
                goalsContent.innerHTML += newGoalHtml;
                
                // Reset form
                document.getElementById('custom-goal-title').value = '';
                document.getElementById('custom-goal-description').value = '';
            }
        }
        
        function finishGoalSelection() {
            if (socket) {
                socket.emit('finish_goal_selection');
                document.getElementById('goals-approval').style.display = 'none';
                showAlert('Goal selection completed. Proceeding to next phase...', 'success');
            }
        }
        
        // Event listeners for dynamic form elements
         document.addEventListener('DOMContentLoaded', function() {
             // Initialize campaigns display and performance summary
             displayCampaignsList();
             updatePerformanceSummary();
             
             // Test function to add sample campaigns for debugging
             window.testAddCampaigns = function() {
                 const testCampaign = {
                     id: campaignIdCounter++,
                     name: 'Test Campaign',
                     type: 'Email',
                     status: 'Draft',
                     segment: 'General',
                     budget: 5000,
                     spent: 0,
                     impressions: 1000,
                     clicks: 50,
                     conversions: 5,
                     created: new Date().toISOString().split('T')[0],
                     lastModified: new Date().toISOString().split('T')[0]
                 };
                 campaigns.push(testCampaign);
                 console.log('🧪 Test campaign added:', testCampaign);
                 displayCampaignsList();
                 updatePerformanceSummary();
             };
             
             // Test function to simulate campaign generation and approval workflow
              window.testApprovalWorkflow = function() {
                  const sampleCampaigns = [
                      {
                          name: 'Email Marketing Campaign',
                          description: 'Targeted email campaign for customer engagement',
                          target_segments: ['Existing Customers'],
                          business_goals: ['Customer Retention'],
                          channels: ['Email'],
                          budget_estimate: 3000,
                          timeline: '4 weeks'
                      },
                      {
                          name: 'Social Media Campaign',
                          description: 'Social media campaign for brand awareness',
                          target_segments: ['New Customers'],
                          business_goals: ['Brand Awareness'],
                          channels: ['Social Media'],
                          budget_estimate: 5000,
                          timeline: '6 weeks'
                      }
                  ];
                  
                  console.log('🧪 Testing approval workflow with sample campaigns');
                  agentGeneratedCampaigns = sampleCampaigns;
                  displayCampaignsForReview(sampleCampaigns);
              };
              
              // Complete test function that simulates the entire workflow
              window.testCompleteWorkflow = function() {
                  console.log('🚀 Starting complete workflow test...');
                  
                  // Step 1: Clear existing campaigns
                  campaigns.length = 0;
                  console.log('1️⃣ Cleared existing campaigns. Current count:', campaigns.length);
                  
                  // Step 2: Add sample campaigns to agentGeneratedCampaigns
                  const sampleCampaigns = [
                      {
                          name: 'Test Email Campaign',
                          description: 'Test email campaign',
                          target_segments: ['Test Segment'],
                          business_goals: ['Test Goal'],
                          channels: ['Email'],
                          budget_estimate: 1000,
                          timeline: '2 weeks'
                      }
                  ];
                  
                  agentGeneratedCampaigns = sampleCampaigns;
                  console.log('2️⃣ Added sample campaigns to agentGeneratedCampaigns:', agentGeneratedCampaigns.length);
                  
                  // Step 3: Display campaigns for review
                  displayCampaignsForReview(sampleCampaigns);
                  console.log('3️⃣ Displayed campaigns for review');
                  
                  // Step 4: Auto-select the first campaign
                  setTimeout(() => {
                      const firstCheckbox = document.querySelector('.marketing-campaign-checkbox');
                      if (firstCheckbox) {
                          firstCheckbox.checked = true;
                          console.log('4️⃣ Auto-selected first campaign');
                          
                          // Step 5: Approve selected campaigns
                          setTimeout(() => {
                              console.log('5️⃣ Approving selected campaigns...');
                              approveSelectedCampaigns();
                              
                              // Step 6: Check results
                              setTimeout(() => {
                                  console.log('6️⃣ Final results:');
                                  console.log('   - Campaigns in All Campaigns:', campaigns.length);
                                  console.log('   - Remaining in Marketing:', agentGeneratedCampaigns.length);
                                  console.log('   - All Campaigns array:', campaigns);
                              }, 1000);
                          }, 1000);
                      }
                  }, 1000);
              };
             
             // Show modification textarea when goal is selected
             document.addEventListener('change', function(e) {
                 if (e.target.id === 'goal-modify-select') {
                     const textArea = document.getElementById('goal-modification-text');
                     const button = document.getElementById('modify-goal-btn');
                     if (e.target.value) {
                         textArea.style.display = 'block';
                         button.style.display = 'inline-block';
                     } else {
                         textArea.style.display = 'none';
                         button.style.display = 'none';
                     }
                 }
             });
         });
        
        // Toggle all marketing campaign checkboxes
        function toggleAllMarketingCampaigns() {
            const selectAllCheckbox = document.getElementById('select-all-marketing-campaigns');
            const campaignCheckboxes = document.querySelectorAll('.marketing-campaign-checkbox');
            
            campaignCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }
        
        // Get selected marketing campaign indices
        function getSelectedMarketingCampaigns() {
            const selectedCheckboxes = document.querySelectorAll('.marketing-campaign-checkbox:checked');
            return Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.value));
        }
        
        // Approve only selected campaigns
        function approveSelectedCampaigns() {
            const selectedIndices = getSelectedMarketingCampaigns();
            
            if (selectedIndices.length === 0) {
                showAlert('Please select at least one campaign to approve.', 'warning');
                return;
            }
            
            console.log('Approving selected campaigns:', selectedIndices);
            
            // Show approval success animation
            showCampaignApprovalSuccessAnimation();
            
            // Convert selected campaigns to management format and add to campaigns array
            selectedIndices.forEach(index => {
                if (agentGeneratedCampaigns[index]) {
                    const managementCampaign = convertSingleCampaignToManagementFormat(agentGeneratedCampaigns[index]);
                    campaigns.push(managementCampaign);
                    console.log('✅ Added campaign to All Campaigns:', managementCampaign.name);
                }
            });
            
            console.log('📊 Total campaigns in All Campaigns section:', campaigns.length);
            
            // Remove approved campaigns from agentGeneratedCampaigns (in reverse order to maintain indices)
            selectedIndices.sort((a, b) => b - a).forEach(index => {
                agentGeneratedCampaigns.splice(index, 1);
            });
            
            // Update displays
            displayCampaignsList();
            updatePerformanceSummary();
            
            // Update results section with approved campaigns
            const resultsData = {
                agent1_result: {
                    campaigns: campaigns,
                    segments: [], 
                    business_goals: []
                },
                agent2_result: null
            };
            displayResults(resultsData);
            document.getElementById('results-section').style.display = 'block';
            
            // Refresh the Marketing Campaign section with remaining campaigns
            if (agentGeneratedCampaigns.length > 0) {
                displayCampaignsForReview(agentGeneratedCampaigns);
            } else {
                document.getElementById('campaigns-content').innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No campaigns pending review. Generate new campaigns from Business Goals to see them here.</div>';
                document.getElementById('campaigns-review').style.display = 'none';
            }
            
            showAlert(`${selectedIndices.length} campaign(s) approved and moved to All Campaigns!`, 'success');
            
            if (socket) {
                socket.emit('approve_campaigns');
            }
        }
        
        // Legacy function for backward compatibility
        function approveCampaigns() {
            // Select all campaigns and approve them
            document.getElementById('select-all-marketing-campaigns').checked = true;
            toggleAllMarketingCampaigns();
            approveSelectedCampaigns();
        }
        
        function modifyCampaigns() {
            const feedback = prompt('Please provide feedback for campaign modifications:');
            if (feedback && socket) {
                socket.emit('modify_campaigns', {feedback: feedback});
                document.getElementById('campaigns-review').style.display = 'none';
                showAlert('Modification request sent to agent', 'info');
            }
        }
        
        // CRUD operations for generated campaigns in Marketing Campaigns section
        function editGeneratedCampaign(index) {
            document.getElementById(`campaign-view-${index}`).style.display = 'none';
            document.getElementById(`campaign-edit-${index}`).style.display = 'block';
        }
        
        function cancelEditGeneratedCampaign(index) {
            document.getElementById(`campaign-view-${index}`).style.display = 'block';
            document.getElementById(`campaign-edit-${index}`).style.display = 'none';
        }
        
        function saveGeneratedCampaign(index) {
            if (!agentGeneratedCampaigns || !agentGeneratedCampaigns[index]) return;
            
            // Get updated values from form
            const updatedCampaign = {
                ...agentGeneratedCampaigns[index],
                name: document.getElementById(`edit-name-${index}`).value,
                description: document.getElementById(`edit-description-${index}`).value,
                target_segments: document.getElementById(`edit-targets-${index}`).value.split(',').map(s => s.trim()),
                channels: document.getElementById(`edit-channels-${index}`).value.split(',').map(s => s.trim()),
                budget_estimate: document.getElementById(`edit-budget-${index}`).value,
                timeline: document.getElementById(`edit-timeline-${index}`).value,
                business_goals: document.getElementById(`edit-goals-${index}`).value.split(',').map(s => s.trim())
            };
            
            // Update the campaign in the array
            agentGeneratedCampaigns[index] = updatedCampaign;
            
            // Refresh the display
            displayCampaignsForReview(agentGeneratedCampaigns);
            
            showAlert('Campaign updated successfully!', 'success');
        }
        
        function deleteGeneratedCampaign(index) {
            if (!agentGeneratedCampaigns || !agentGeneratedCampaigns[index]) return;
            
            if (confirm('Are you sure you want to delete this campaign?')) {
                agentGeneratedCampaigns.splice(index, 1);
                displayCampaignsForReview(agentGeneratedCampaigns);
                showAlert('Campaign deleted successfully!', 'success');
                
                // Clear Marketing Campaign section if no campaigns left
                if (agentGeneratedCampaigns.length === 0) {
                    document.getElementById('campaigns-content').innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No campaigns pending review. Generate new campaigns from Business Goals to see them here.</div>';
                    document.getElementById('campaigns-review').style.display = 'none';
                }
            }
        }
        
        // Individual campaign approval function removed - now using selection-based approval
        
        function convertSingleCampaignToManagementFormat(campaign) {
            const budget = parseFloat(campaign.budget_estimate?.toString().replace(/[^\d.]/g, '')) || 5000;
            const channels = Array.isArray(campaign.channels) ? campaign.channels : [];
            const primaryChannel = channels[0] || 'Multi-channel';
            
            return {
                id: campaignIdCounter++,
                name: campaign.name || 'Unnamed Campaign',
                type: primaryChannel.charAt(0).toUpperCase() + primaryChannel.slice(1),
                status: 'Draft',
                segment: Array.isArray(campaign.target_segments) ? campaign.target_segments.join(', ') : 'General',
                budget: budget,
                spent: 0,
                impressions: Math.floor(Math.random() * 10000),
                clicks: Math.floor(Math.random() * 500),
                conversions: Math.floor(Math.random() * 50),
                created: new Date().toISOString().split('T')[0],
                lastModified: new Date().toISOString().split('T')[0]
            };
        }
        
        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        // Drag and drop handling
        const uploadArea = document.querySelector('.upload-area');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            document.getElementById('fileInput').files = files;
            handleFileSelect({ target: { files } });
        });
        
        function handleFileSelect(event) {
            const files = event.target.files;
            const fileList = document.getElementById('file-list');
            const selectedFiles = document.getElementById('selected-files');
            const uploadBtn = document.getElementById('upload-btn');
            
            if (files.length > 0) {
                fileList.style.display = 'block';
                uploadBtn.style.display = 'inline-block';
                
                selectedFiles.innerHTML = '';
                for (let file of files) {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-file me-2"></i>${file.name} (${formatFileSize(file.size)})`;
                    selectedFiles.appendChild(li);
                }
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            const uploadBtn = document.getElementById('upload-btn');
            
            if (files.length === 0) {
                showAlert('Please select files to upload.', 'danger');
                return;
            }
            
            // Update button to uploading state
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
            uploadBtn.disabled = true;
            uploadBtn.classList.remove('btn-primary-custom');
            uploadBtn.classList.add('btn-warning');
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('file', file);
            }
            
            showAlert('Uploading files...', 'info');
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update button to uploaded state
                    uploadBtn.innerHTML = '<i class="fas fa-check me-2"></i>Uploaded';
                    uploadBtn.classList.remove('btn-warning');
                    uploadBtn.classList.add('btn-success');
                    
                    showAlert('Files uploaded successfully!', 'success');
                    filesProcessed += files.length;
                    updateStats();
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Upload Files';
                        uploadBtn.disabled = false;
                        uploadBtn.classList.remove('btn-success');
                        uploadBtn.classList.add('btn-primary-custom');
                    }, 3000);
                } else {
                    // Reset button on error
                    uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Upload Files';
                    uploadBtn.disabled = false;
                    uploadBtn.classList.remove('btn-warning');
                    uploadBtn.classList.add('btn-primary-custom');
                    
                    showAlert('Upload failed: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                // Reset button on error
                uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Upload Files';
                uploadBtn.disabled = false;
                uploadBtn.classList.remove('btn-warning');
                uploadBtn.classList.add('btn-primary-custom');
                
                showAlert('Upload error: ' + error.message, 'danger');
            });
        }
        
        function useSampleData() {
            const sampleBtn = document.querySelector('button[onclick="useSampleData()"]');
            
            // Change button to success state
            sampleBtn.innerHTML = '<i class="fas fa-check me-2"></i>Data Loaded';
            sampleBtn.classList.remove('btn-outline-custom');
            sampleBtn.classList.add('btn-success');
            sampleBtn.disabled = true;
            
            showAlert('Sample data loaded successfully!', 'success');
            updateStats();
            
            // Reset button after 3 seconds
            setTimeout(() => {
                sampleBtn.innerHTML = '<i class="fas fa-database me-2"></i>Use Sample Data';
                sampleBtn.classList.remove('btn-success');
                sampleBtn.classList.add('btn-outline-custom');
                sampleBtn.disabled = false;
            }, 3000);
        }
        
        function processAgents() {
            if (isProcessing) {
                showAlert('Processing is already in progress.', 'warning');
                return;
            }
            
            const processBtn = document.getElementById('process-btn');
            
            fetch('/process_agents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data_type: 'sample' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Change button to success state
                    processBtn.innerHTML = '<i class="fas fa-check me-2"></i>Processing Started';
                    processBtn.classList.remove('btn-primary-custom');
                    processBtn.classList.add('btn-success');
                    
                    showAlert(data.message || 'Processing started successfully!', 'info');
                    // The actual processing will be handled via WebSocket events
                    // UI updates will come through the socket listeners
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        processBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Processing';
                        processBtn.classList.remove('btn-success');
                        processBtn.classList.add('btn-primary-custom');
                    }, 3000);
                } else {
                    showAlert('Processing failed to start: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Processing error: ' + error.message, 'danger');
                resetProcessingUI();
            });
        }
        
        function displayResults(data) {
            const resultsContent = document.getElementById('results-content');
            
            // Extract campaign predictions and performance data from Agent2 results
            const agent2Result = data.agent2_result || {};
            const agent1Result = data.agent1_result || {};
            
            // Generate enhanced campaign predictions
            const campaignPredictions = generateCampaignPredictions(agent1Result, agent2Result);
            const topCampaigns = agent2Result.top_performing_campaigns || [];
            const improvementSuggestions = agent2Result.improvement_suggestions || [];
            const performanceSummary = calculatePerformanceSummary(campaignPredictions);
            
            // Populate all results sections with predictions
            populateResultsSectionsWithPredictions(agent1Result, agent2Result, campaignPredictions, performanceSummary);
            
            resultsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-brain me-2 text-white"></i>Agent 1 Results</h5>
                        <div class="result-container">
                            <div class="result-json">${JSON.stringify(data.agent1_result, null, 2)}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-cogs me-2"></i>Agent 2 Implementation</h5>
                        <div class="result-container">
                            <div class="result-json">${JSON.stringify(data.agent2_result, null, 2)}</div>
                        </div>
                    </div>
                </div>
                
                ${Object.keys(campaignPredictions).length > 0 ? `
                <!-- Campaign Performance Predictions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h5><i class="fas fa-chart-line me-2 text-primary"></i>Campaign Performance Predictions</h5>
                        
                        <!-- Performance Summary -->
                        ${Object.keys(performanceSummary).length > 0 ? `
                        <div class="card mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-trophy me-2"></i>Overall Performance Summary</h6>
                                <div class="row text-center">
                                    <div class="col-md-2">
                                        <div class="h4 mb-0">${performanceSummary.total_predicted_conversions || 0}</div>
                                        <small>Total Conversions</small>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="h4 mb-0">${performanceSummary.average_conversion_rate || 0}%</div>
                                        <small>Avg Conversion Rate</small>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="h4 mb-0">${performanceSummary.average_ctr || 0}%</div>
                                        <small>Avg CTR</small>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="h4 mb-0">$${(performanceSummary.total_expected_revenue || 0).toLocaleString()}</div>
                                        <small>Expected Revenue</small>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="h4 mb-0">${performanceSummary.average_engagement_score || 0}/100</div>
                                        <small>Avg Engagement Score</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Individual Campaign Predictions -->
                        <div class="row">
                            ${Object.entries(campaignPredictions).map(([campaignId, prediction]) => `
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="fas fa-bullhorn me-2"></i>${prediction.campaign_name}</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row text-center mb-3">
                                                <div class="col-6">
                                                    <div class="h5 text-success">${prediction.expected_metrics.total_conversions}</div>
                                                    <small class="text-muted">Conversions</small>
                                                </div>
                                                <div class="col-6">
                                                    <div class="h5 text-info">${prediction.expected_metrics.expected_roi}%</div>
                                                    <small class="text-muted">Expected ROI</small>
                                                </div>
                                            </div>
                                            <div class="row text-center mb-3">
                                                <div class="col-4">
                                                    <div class="h6">${prediction.expected_metrics.conversion_rate}%</div>
                                                    <small class="text-muted">Conv. Rate</small>
                                                </div>
                                                <div class="col-4">
                                                    <div class="h6">${prediction.expected_metrics.ctr}%</div>
                                                    <small class="text-muted">CTR</small>
                                                </div>
                                                <div class="col-4">
                                                    <div class="h6">${prediction.expected_metrics.customer_engagement_score}</div>
                                                    <small class="text-muted">Engagement</small>
                                                </div>
                                            </div>
                                            <div class="small text-muted">
                                                <strong>Confidence:</strong> ${prediction.confidence_level}%<br>
                                                <strong>Expected Revenue:</strong> $${prediction.expected_metrics.estimated_revenue.toLocaleString()}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${topCampaigns.length > 0 ? `
                <!-- Top Performing Campaigns -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h5><i class="fas fa-star me-2 text-warning"></i>Top Performing Campaigns</h5>
                        <div class="row">
                            ${topCampaigns.map((campaign, index) => `
                                <div class="col-md-4 mb-3">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">
                                                <i class="fas fa-medal me-2"></i>#${index + 1} ${campaign.campaign_name}
                                                <span class="badge bg-dark float-end">${campaign.composite_score}</span>
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-2">
                                                <strong>Key Strengths:</strong>
                                                <ul class="small mb-0 mt-1">
                                                    ${campaign.key_strengths.map(strength => `<li>${strength}</li>`).join('')}
                                                </ul>
                                            </div>
                                            <div class="row text-center small">
                                                <div class="col-6">
                                                    <div class="text-success font-weight-bold">${campaign.predicted_metrics.expected_roi}%</div>
                                                    <div class="text-muted">ROI</div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="text-primary font-weight-bold">${campaign.predicted_metrics.total_conversions}</div>
                                                    <div class="text-muted">Conversions</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${improvementSuggestions.length > 0 ? `
                <!-- Improvement Suggestions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h5><i class="fas fa-lightbulb me-2 text-info"></i>Campaign Improvement Suggestions</h5>
                        <div class="accordion" id="improvementAccordion">
                            ${improvementSuggestions.map((suggestion, index) => `
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading${index}">
                                        <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="collapse${index}">
                                            <i class="fas fa-bullhorn me-2"></i>${suggestion.campaign_name}
                                            <span class="badge bg-info ms-2">${suggestion.improvements.length} suggestions</span>
                                        </button>
                                    </h2>
                                    <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="heading${index}" data-bs-parent="#improvementAccordion">
                                        <div class="accordion-body">
                                            ${suggestion.improvements.map(improvement => `
                                                <div class="card mb-2">
                                                    <div class="card-body py-2">
                                                        <h6 class="card-title mb-1 text-primary">${improvement.area}</h6>
                                                        <p class="card-text mb-1 small">${improvement.suggestion}</p>
                                                        <small class="text-success"><i class="fas fa-arrow-up me-1"></i>${improvement.impact}</small>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div class="mt-4">
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-danger" onclick="downloadResults('pdf')">
                            <i class="fas fa-file-pdf me-2"></i>Download PDF
                        </button>
                        <button class="btn btn-success" onclick="downloadResults('excel')">
                            <i class="fas fa-file-excel me-2"></i>Download Excel
                        </button>
                        <button class="btn btn-primary" onclick="downloadResults('json')">
                            <i class="fas fa-file-code me-2"></i>Download JSON
                        </button>
                    </div>
                    <small class="text-muted mt-2 d-block">Choose your preferred format for the complete marketing analysis results</small>
                </div>
            `;
        }
        
        function downloadResults(format) {
            const downloadBtn = document.querySelector(`button[onclick="downloadResults('${format}')"]`);
            const originalContent = downloadBtn.innerHTML;
            
            // Change button to loading state
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Downloading...';
            downloadBtn.disabled = true;
            
            // Make API call to download the file
            fetch(`/export/${format}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    
                    // Set filename based on format
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    let filename;
                    switch(format) {
                        case 'pdf':
                            filename = `marketing_analysis_${timestamp}.pdf`;
                            break;
                        case 'excel':
                            filename = `marketing_analysis_${timestamp}.xlsx`;
                            break;
                        case 'json':
                            filename = `marketing_analysis_${timestamp}.json`;
                            break;
                        default:
                            filename = `marketing_analysis_${timestamp}.${format}`;
                    }
                    a.download = filename;
                    
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Change button to success state
                    downloadBtn.innerHTML = '<i class="fas fa-check me-2"></i>Downloaded';
                    downloadBtn.classList.add('btn-success');
                    showAlert(`${format.toUpperCase()} file downloaded successfully!`, 'success');
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        downloadBtn.innerHTML = originalContent;
                        downloadBtn.classList.remove('btn-success');
                        downloadBtn.disabled = false;
                    }, 3000);
                })
                .catch(error => {
                    console.error('Download error:', error);
                    downloadBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                    downloadBtn.classList.add('btn-danger');
                    showAlert(`Failed to download ${format.toUpperCase()} file. Please try again.`, 'error');
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        downloadBtn.innerHTML = originalContent;
                        downloadBtn.classList.remove('btn-danger');
                        downloadBtn.disabled = false;
                    }, 3000);
                });
        }
        
        function downloadImplementationPlan(format) {
            const downloadBtn = document.querySelector(`button[onclick="downloadImplementationPlan('${format}')"]`);
            const originalContent = downloadBtn.innerHTML;
            
            // Change button to loading state
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Downloading...';
            downloadBtn.disabled = true;
            
            // Make API call to download the implementation plan file
            fetch(`/export/implementation/${format}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    
                    // Set filename based on format
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    let filename;
                    switch(format) {
                        case 'pdf':
                            filename = `implementation_plan_${timestamp}.pdf`;
                            break;
                        case 'excel':
                            filename = `implementation_plan_${timestamp}.xlsx`;
                            break;
                        case 'json':
                            filename = `implementation_plan_${timestamp}.json`;
                            break;
                        default:
                            filename = `implementation_plan_${timestamp}.${format}`;
                    }
                    a.download = filename;
                    
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Change button to success state
                    downloadBtn.innerHTML = '<i class="fas fa-check me-2"></i>Downloaded';
                    downloadBtn.classList.add('btn-success');
                    showAlert(`Implementation plan ${format.toUpperCase()} file downloaded successfully!`, 'success');
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        downloadBtn.innerHTML = originalContent;
                        downloadBtn.classList.remove('btn-success');
                        downloadBtn.disabled = false;
                    }, 3000);
                })
                .catch(error => {
                    console.error('Implementation plan download error:', error);
                    downloadBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                    downloadBtn.classList.add('btn-danger');
                    showAlert(`Failed to download implementation plan ${format.toUpperCase()} file. Please try again.`, 'error');
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        downloadBtn.innerHTML = originalContent;
                        downloadBtn.classList.remove('btn-danger');
                        downloadBtn.disabled = false;
                    }, 3000);
                });
        }
        
        // Campaign Management Variables
        let campaigns = []; // Will be populated from agent-generated campaigns
        let agentGeneratedCampaigns = []; // Store original agent campaigns
        
        // Load campaigns for review from API on page load
        function loadApprovedCampaigns() {
            fetch('/api/campaigns')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.campaigns.length > 0) {
                        // Load campaigns into Marketing Campaigns section for review and selection
                        agentGeneratedCampaigns = data.campaigns;
                        displayCampaignsForReview(data.campaigns);
                        
                        // Also add approved campaigns to the All Campaigns section
                        addApprovedCampaignsToAllSection(data.campaigns);
                        
                        console.log(`✅ Loaded ${data.campaigns.length} campaigns for review and added to all campaigns`);
                    }
                })
                .catch(error => {
                    console.error('Error loading campaigns for review:', error);
                });
        }
        
        // Load campaigns when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadApprovedCampaigns();
        });
        let campaignIdCounter = 1; // For generating unique IDs
        
        // Function to add approved campaigns from API to the All Campaigns section
        function addApprovedCampaignsToAllSection(approvedCampaigns) {
            if (!approvedCampaigns || approvedCampaigns.length === 0) {
                console.log('No approved campaigns to add to all campaigns section');
                return;
            }
            
            console.log('Adding approved campaigns to all campaigns section:', approvedCampaigns);
            
            // Convert approved campaigns to the format expected by displayCampaignsList
            const convertedCampaigns = approvedCampaigns.map((campaign, index) => {
                const campaignId = campaignIdCounter++;
                return {
                    id: campaignId,
                    name: campaign.name || `Campaign ${campaignId}`,
                    type: campaign.type || 'Digital Marketing',
                    status: 'Active',
                    budget: parseFloat(campaign.budget_estimate?.replace(/[^\d.-]/g, '')) || 10000,
                    spent: 0,
                    impressions: 0,
                    clicks: 0,
                    conversions: 0,
                    segment: Array.isArray(campaign.target_segments) ? campaign.target_segments.join(', ') : (campaign.target_segments || 'All segments'),
                    created: new Date().toLocaleDateString(),
                    lastModified: new Date().toLocaleDateString(),
                    description: campaign.description || '',
                    channels: Array.isArray(campaign.channels) ? campaign.channels.join(', ') : (campaign.channels || 'Multi-channel'),
                    timeline: campaign.timeline || 'TBD',
                    success_metrics: campaign.success_metrics || [],
                    content: campaign.content || ''
                };
            });
            
            // Add converted campaigns to the campaigns array (avoid duplicates)
            convertedCampaigns.forEach(newCampaign => {
                const existingCampaign = campaigns.find(c => c.name === newCampaign.name);
                if (!existingCampaign) {
                    campaigns.push(newCampaign);
                }
            });
            
            // Refresh the campaigns list display
            displayCampaignsList();
            
            // Update the campaigns count in overview
            updateResultsOverview({
                campaigns: campaigns.length.toString()
            });
            
            console.log(`✅ Added ${convertedCampaigns.length} approved campaigns to all campaigns section. Total campaigns: ${campaigns.length}`);
        }
        
        let editingCampaignId = null;
        
        // Enhanced Campaign Prediction Functions
        function generateCampaignPredictions(agent1Result, agent2Result) {
            const predictions = {};
            
            if (agent1Result.campaigns) {
                agent1Result.campaigns.forEach((campaign, index) => {
                    const campaignId = `campaign_${index}`;
                    const baseMetrics = calculateBaseCampaignMetrics(campaign, agent1Result.segments);
                    
                    predictions[campaignId] = {
                        campaign_name: campaign.name || `Campaign ${index + 1}`,
                        campaign_type: campaign.type || 'Digital Marketing',
                        target_segments: campaign.target_segments || [],
                        channels: campaign.channels || [],
                        budget_estimate: campaign.budget_estimate || '$10,000',
                        expected_metrics: {
                            total_conversions: baseMetrics.conversions,
                            conversion_rate: baseMetrics.conversionRate,
                            expected_roi: baseMetrics.roi,
                            click_through_rate: baseMetrics.ctr,
                            engagement_score: baseMetrics.engagement,
                            reach_estimate: baseMetrics.reach,
                            cost_per_acquisition: baseMetrics.cpa,
                            lifetime_value: baseMetrics.ltv
                        },
                        performance_forecast: {
                            week_1: { conversions: Math.round(baseMetrics.conversions * 0.15), revenue: baseMetrics.revenue * 0.15 },
                            week_2: { conversions: Math.round(baseMetrics.conversions * 0.25), revenue: baseMetrics.revenue * 0.25 },
                            week_3: { conversions: Math.round(baseMetrics.conversions * 0.35), revenue: baseMetrics.revenue * 0.35 },
                            week_4: { conversions: Math.round(baseMetrics.conversions * 0.25), revenue: baseMetrics.revenue * 0.25 }
                        },
                        risk_assessment: {
                            risk_level: baseMetrics.riskLevel,
                            confidence_score: baseMetrics.confidence,
                            key_risks: baseMetrics.risks
                        },
                        optimization_suggestions: generateOptimizationSuggestions(campaign, baseMetrics)
                    };
                });
            }
            
            return predictions;
        }
        
        function calculateBaseCampaignMetrics(campaign, segments) {
            // Calculate metrics based on campaign characteristics and target segments
            const targetSegments = campaign.target_segments || [];
            const channels = campaign.channels || [];
            const budgetNum = parseFloat(campaign.budget_estimate?.replace(/[^\d.-]/g, '')) || 10000;
            
            // Base conversion rates by channel
            const channelRates = {
                'email': { ctr: 3.2, conversion: 2.1, cpa: 45 },
                'social_media': { ctr: 1.8, conversion: 1.3, cpa: 65 },
                'search': { ctr: 4.5, conversion: 3.2, cpa: 55 },
                'display': { ctr: 0.9, conversion: 0.7, cpa: 75 },
                'content': { ctr: 2.1, conversion: 1.8, cpa: 50 }
            };
            
            // Calculate weighted averages based on channels
            let avgCtr = 2.5, avgConversion = 1.8, avgCpa = 60;
            if (channels.length > 0) {
                const channelMetrics = channels.map(ch => channelRates[ch.toLowerCase()] || channelRates['display']);
                avgCtr = channelMetrics.reduce((sum, m) => sum + m.ctr, 0) / channelMetrics.length;
                avgConversion = channelMetrics.reduce((sum, m) => sum + m.conversion, 0) / channelMetrics.length;
                avgCpa = channelMetrics.reduce((sum, m) => sum + m.cpa, 0) / channelMetrics.length;
            }
            
            // Segment quality multiplier
            let segmentMultiplier = 1.0;
            if (segments && targetSegments.length > 0) {
                const relevantSegments = segments.filter(s => 
                    targetSegments.some(ts => s.name?.toLowerCase().includes(ts.toLowerCase()))
                );
                if (relevantSegments.length > 0) {
                    const avgPriority = relevantSegments.reduce((sum, s) => sum + (s.priority_score || 5), 0) / relevantSegments.length;
                    segmentMultiplier = 0.7 + (avgPriority / 10) * 0.6; // Range: 0.7 to 1.3
                }
            }
            
            // Calculate final metrics
            const reach = Math.round(budgetNum * 15 * segmentMultiplier); // Estimated reach
            const clicks = Math.round(reach * (avgCtr / 100));
            const conversions = Math.round(clicks * (avgConversion / 100));
            const revenue = conversions * 150; // Average order value
            const roi = ((revenue - budgetNum) / budgetNum * 100);
            const engagement = Math.min(95, 60 + (avgCtr * 8) + (segmentMultiplier * 10));
            
            // Risk assessment
            let riskLevel = 'Medium';
            let confidence = 75;
            const risks = [];
            
            if (budgetNum < 5000) {
                risks.push('Limited budget may restrict reach');
                riskLevel = 'High';
                confidence -= 15;
            }
            if (channels.length === 1) {
                risks.push('Single channel dependency');
                confidence -= 10;
            }
            if (segmentMultiplier < 0.9) {
                risks.push('Target segments may have lower engagement');
                confidence -= 10;
            }
            
            if (confidence > 80) riskLevel = 'Low';
            else if (confidence < 60) riskLevel = 'High';
            
            return {
                conversions,
                conversionRate: avgConversion,
                roi: Math.round(roi),
                ctr: avgCtr,
                engagement: Math.round(engagement),
                reach,
                cpa: Math.round(avgCpa),
                ltv: Math.round(conversions * 450), // Lifetime value
                revenue,
                riskLevel,
                confidence: Math.round(confidence),
                risks
            };
        }
        
        function generateOptimizationSuggestions(campaign, metrics) {
            const suggestions = [];
            
            if (metrics.ctr < 2.0) {
                suggestions.push('Improve ad creative and headlines to increase click-through rate');
            }
            if (metrics.conversionRate < 2.0) {
                suggestions.push('Optimize landing pages and call-to-action elements');
            }
            if (metrics.cpa > 70) {
                suggestions.push('Consider audience refinement to reduce cost per acquisition');
            }
            if (campaign.channels && campaign.channels.length === 1) {
                suggestions.push('Expand to additional marketing channels for better reach');
            }
            if (metrics.engagement < 70) {
                suggestions.push('Enhance content relevance and personalization');
            }
            
            return suggestions;
        }
        
        function calculatePerformanceSummary(campaignPredictions) {
            const campaigns = Object.values(campaignPredictions);
            if (campaigns.length === 0) return {};
            
            const totalConversions = campaigns.reduce((sum, c) => sum + c.expected_metrics.total_conversions, 0);
            const avgConversionRate = campaigns.reduce((sum, c) => sum + c.expected_metrics.conversion_rate, 0) / campaigns.length;
            const avgCtr = campaigns.reduce((sum, c) => sum + c.expected_metrics.click_through_rate, 0) / campaigns.length;
            const totalRevenue = campaigns.reduce((sum, c) => sum + (c.expected_metrics.total_conversions * 150), 0);
            const avgEngagement = campaigns.reduce((sum, c) => sum + c.expected_metrics.engagement_score, 0) / campaigns.length;
            const avgRoi = campaigns.reduce((sum, c) => sum + c.expected_metrics.expected_roi, 0) / campaigns.length;
            
            return {
                total_predicted_conversions: totalConversions,
                average_conversion_rate: Math.round(avgConversionRate * 10) / 10,
                average_ctr: Math.round(avgCtr * 10) / 10,
                total_expected_revenue: Math.round(totalRevenue),
                average_engagement_score: Math.round(avgEngagement),
                average_roi: Math.round(avgRoi),
                total_campaigns: campaigns.length,
                high_confidence_campaigns: campaigns.filter(c => c.risk_assessment.confidence_score > 80).length
            };
        }
        
        function populateResultsSectionsWithPredictions(agent1Result, agent2Result, campaignPredictions, performanceSummary) {
            // Update Overview Section with predictions
            updateResultsOverview({
                segments: agent1Result.segments?.length || 0,
                goals: agent1Result.business_goals?.length || 0,
                campaigns: Object.keys(campaignPredictions).length,
                processing_time: '2.3s'
            });
            
            // Populate Analytics with prediction data
            populateAnalyticsSectionWithPredictions(campaignPredictions, performanceSummary);
            
            // Populate Performance with prediction metrics
            populatePerformanceSectionWithPredictions(campaignPredictions, performanceSummary);
            
            // Populate Insights with prediction-based insights
            populateInsightsSectionWithPredictions(campaignPredictions, performanceSummary);
            
            // Update Agent Results with prediction details
            populateAgentResultsWithPredictions(agent1Result, agent2Result, campaignPredictions);
        }
        
        function populateAnalyticsSectionWithPredictions(campaignPredictions, performanceSummary) {
            const analyticsContent = document.getElementById('analytics-content');
            if (!analyticsContent) return;
            
            const campaigns = Object.values(campaignPredictions);
            
            analyticsContent.innerHTML = `
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h4><i class="fas fa-chart-line"></i> Campaign Performance Forecast</h4>
                        </div>
                        <div class="analytics-body">
                            <div class="metric-row">
                                <span class="metric-label">Total Expected Conversions:</span>
                                <span class="metric-value">${performanceSummary.total_predicted_conversions || 0}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Average Conversion Rate:</span>
                                <span class="metric-value">${performanceSummary.average_conversion_rate || 0}%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Expected Revenue:</span>
                                <span class="metric-value">$${(performanceSummary.total_expected_revenue || 0).toLocaleString()}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Average ROI:</span>
                                <span class="metric-value text-success">${performanceSummary.average_roi || 0}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h4><i class="fas fa-target"></i> Channel Performance Analysis</h4>
                        </div>
                        <div class="analytics-body">
                            ${generateChannelAnalytics(campaigns)}
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h4><i class="fas fa-users"></i> Audience Insights</h4>
                        </div>
                        <div class="analytics-body">
                            ${generateAudienceInsights(campaigns)}
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <h4><i class="fas fa-calendar-week"></i> Weekly Forecast</h4>
                        </div>
                        <div class="analytics-body">
                            ${generateWeeklyForecast(campaigns)}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function populatePerformanceSectionWithPredictions(campaignPredictions, performanceSummary) {
            const performanceContent = document.getElementById('performance-content');
            if (!performanceContent) return;
            
            const campaigns = Object.values(campaignPredictions);
            
            performanceContent.innerHTML = `
                <div class="performance-dashboard">
                    <div class="performance-summary">
                        <div class="summary-card">
                            <div class="summary-icon"><i class="fas fa-bullseye"></i></div>
                            <div class="summary-content">
                                <h3>${performanceSummary.total_predicted_conversions || 0}</h3>
                                <p>Predicted Conversions</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"><i class="fas fa-percentage"></i></div>
                            <div class="summary-content">
                                <h3>${performanceSummary.average_conversion_rate || 0}%</h3>
                                <p>Avg Conversion Rate</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"><i class="fas fa-dollar-sign"></i></div>
                            <div class="summary-content">
                                <h3>$${(performanceSummary.total_expected_revenue || 0).toLocaleString()}</h3>
                                <p>Expected Revenue</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"><i class="fas fa-chart-line"></i></div>
                            <div class="summary-content">
                                <h3>${performanceSummary.average_roi || 0}%</h3>
                                <p>Average ROI</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="performance-details">
                        <div class="performance-table">
                            <h4>Campaign Performance Breakdown</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Campaign</th>
                                        <th>Type</th>
                                        <th>Conversions</th>
                                        <th>Conv. Rate</th>
                                        <th>ROI</th>
                                        <th>Risk Level</th>
                                        <th>Confidence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${campaigns.map(campaign => `
                                        <tr>
                                            <td>${campaign.campaign_name}</td>
                                            <td>${campaign.campaign_type}</td>
                                            <td>${campaign.expected_metrics.total_conversions}</td>
                                            <td>${campaign.expected_metrics.conversion_rate}%</td>
                                            <td class="${campaign.expected_metrics.expected_roi > 0 ? 'text-success' : 'text-danger'}">
                                                ${campaign.expected_metrics.expected_roi}%
                                            </td>
                                            <td>
                                                <span class="badge badge-${getRiskBadgeColor(campaign.risk_assessment.risk_level)}">
                                                    ${campaign.risk_assessment.risk_level}
                                                </span>
                                            </td>
                                            <td>${campaign.risk_assessment.confidence_score}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function populateInsightsSectionWithPredictions(campaignPredictions, performanceSummary) {
            const insightsContent = document.getElementById('insights-content');
            if (!insightsContent) return;
            
            const campaigns = Object.values(campaignPredictions);
            const insights = generateInsightsFromPredictions(campaigns, performanceSummary);
            
            insightsContent.innerHTML = `
                <div class="insights-container">
                    <div class="insights-section">
                        <h4><i class="fas fa-lightbulb"></i> Key Insights</h4>
                        <div class="insights-list">
                            ${insights.keyInsights.map(insight => `
                                <div class="insight-item">
                                    <div class="insight-icon ${insight.type}">
                                        <i class="fas ${insight.icon}"></i>
                                    </div>
                                    <div class="insight-content">
                                        <h5>${insight.title}</h5>
                                        <p>${insight.description}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="insights-section">
                        <h4><i class="fas fa-exclamation-triangle"></i> Recommendations</h4>
                        <div class="recommendations-list">
                            ${insights.recommendations.map(rec => `
                                <div class="recommendation-item">
                                    <div class="recommendation-priority ${rec.priority}">
                                        ${rec.priority.toUpperCase()}
                                    </div>
                                    <div class="recommendation-content">
                                        <h5>${rec.title}</h5>
                                        <p>${rec.description}</p>
                                        <div class="recommendation-impact">
                                            <small>Expected Impact: ${rec.impact}</small>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="insights-section">
                        <h4><i class="fas fa-chart-pie"></i> Performance Distribution</h4>
                        <div class="performance-distribution">
                            ${generatePerformanceDistribution(campaigns)}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function populateAgentResultsWithPredictions(agent1Result, agent2Result, campaignPredictions) {
            // Update Agent 1 Results with prediction context
            const agent1Content = document.getElementById('agent1-results');
            if (agent1Content && agent1Result) {
                const existingContent = agent1Content.innerHTML;
                const predictionSummary = `
                    <div class="prediction-summary mt-3">
                        <h5><i class="fas fa-crystal-ball"></i> Campaign Predictions Generated</h5>
                        <p>Generated detailed predictions for ${Object.keys(campaignPredictions).length} campaigns with performance forecasts, risk assessments, and optimization recommendations.</p>
                    </div>
                `;
                agent1Content.innerHTML = existingContent + predictionSummary;
            }
            
            // Update Agent 2 Results with enhanced insights
            const agent2Content = document.getElementById('agent2-results');
            if (agent2Content && agent2Result) {
                const existingContent = agent2Content.innerHTML;
                const enhancedInsights = `
                    <div class="enhanced-insights mt-3">
                        <h5><i class="fas fa-brain"></i> Enhanced Analysis</h5>
                        <p>Campaign predictions have been enhanced with advanced analytics, performance forecasting, and strategic recommendations based on the initial analysis.</p>
                    </div>
                `;
                agent2Content.innerHTML = existingContent + enhancedInsights;
            }
        }
        
        // Helper functions for generating detailed analytics content
        function generateChannelAnalytics(campaigns) {
            const channelData = {};
            
            campaigns.forEach(campaign => {
                campaign.channels.forEach(channel => {
                    if (!channelData[channel]) {
                        channelData[channel] = {
                            conversions: 0,
                            totalBudget: 0,
                            campaigns: 0,
                            avgCtr: 0,
                            avgRoi: 0
                        };
                    }
                    
                    channelData[channel].conversions += campaign.expected_metrics.total_conversions;
                    channelData[channel].totalBudget += parseFloat(campaign.budget_estimate.replace(/[^\d.-]/g, '')) || 0;
                    channelData[channel].campaigns += 1;
                    channelData[channel].avgCtr += campaign.expected_metrics.click_through_rate;
                    channelData[channel].avgRoi += campaign.expected_metrics.expected_roi;
                });
            });
            
            // Calculate averages
            Object.keys(channelData).forEach(channel => {
                const data = channelData[channel];
                data.avgCtr = Math.round((data.avgCtr / data.campaigns) * 10) / 10;
                data.avgRoi = Math.round((data.avgRoi / data.campaigns) * 10) / 10;
            });
            
            if (Object.keys(channelData).length === 0) {
                return '<p class="text-muted">No channel data available</p>';
            }
            
            return Object.entries(channelData).map(([channel, data]) => `
                <div class="channel-metric">
                    <div class="channel-name">
                        <i class="fas fa-${getChannelIcon(channel)}"></i>
                        ${channel.replace('_', ' ').toUpperCase()}
                    </div>
                    <div class="channel-stats">
                        <small>Conversions: ${data.conversions} | CTR: ${data.avgCtr}% | ROI: ${data.avgRoi}%</small>
                    </div>
                </div>
            `).join('');
        }
        
        function generateAudienceInsights(campaigns) {
            const segmentData = {};
            let totalReach = 0;
            
            campaigns.forEach(campaign => {
                totalReach += campaign.expected_metrics.reach_estimate;
                campaign.target_segments.forEach(segment => {
                    if (!segmentData[segment]) {
                        segmentData[segment] = {
                            campaigns: 0,
                            totalConversions: 0,
                            avgEngagement: 0
                        };
                    }
                    
                    segmentData[segment].campaigns += 1;
                    segmentData[segment].totalConversions += campaign.expected_metrics.total_conversions;
                    segmentData[segment].avgEngagement += campaign.expected_metrics.engagement_score;
                });
            });
            
            // Calculate averages
            Object.keys(segmentData).forEach(segment => {
                const data = segmentData[segment];
                data.avgEngagement = Math.round((data.avgEngagement / data.campaigns) * 10) / 10;
            });
            
            return `
                <div class="audience-summary">
                    <div class="metric-row">
                        <span class="metric-label">Total Estimated Reach:</span>
                        <span class="metric-value">${totalReach.toLocaleString()}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Target Segments:</span>
                        <span class="metric-value">${Object.keys(segmentData).length}</span>
                    </div>
                </div>
                <div class="segment-breakdown">
                    ${Object.entries(segmentData).slice(0, 5).map(([segment, data]) => `
                        <div class="segment-item">
                            <div class="segment-name">${segment}</div>
                            <div class="segment-stats">
                                <small>Campaigns: ${data.campaigns} | Conversions: ${data.totalConversions} | Engagement: ${data.avgEngagement}%</small>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function generateWeeklyForecast(campaigns) {
            const weeklyTotals = {
                week_1: { conversions: 0, revenue: 0 },
                week_2: { conversions: 0, revenue: 0 },
                week_3: { conversions: 0, revenue: 0 },
                week_4: { conversions: 0, revenue: 0 }
            };
            
            campaigns.forEach(campaign => {
                Object.keys(weeklyTotals).forEach(week => {
                    weeklyTotals[week].conversions += campaign.performance_forecast[week].conversions;
                    weeklyTotals[week].revenue += campaign.performance_forecast[week].revenue;
                });
            });
            
            return `
                <div class="weekly-forecast-chart">
                    ${Object.entries(weeklyTotals).map(([week, data], index) => `
                        <div class="week-bar">
                            <div class="week-label">Week ${index + 1}</div>
                            <div class="week-metrics">
                                <div class="conversions-bar" style="height: ${(data.conversions / Math.max(...Object.values(weeklyTotals).map(w => w.conversions))) * 100}%"></div>
                                <div class="week-stats">
                                    <div>${data.conversions} conv.</div>
                                    <div>$${Math.round(data.revenue).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function generateInsightsFromPredictions(campaigns, performanceSummary) {
            const insights = {
                keyInsights: [],
                recommendations: []
            };
            
            // Generate key insights
            if (performanceSummary.average_roi > 150) {
                insights.keyInsights.push({
                    type: 'success',
                    icon: 'fa-chart-line',
                    title: 'High ROI Potential',
                    description: `Your campaigns show excellent ROI potential with an average of ${performanceSummary.average_roi}%. This indicates strong market alignment.`
                });
            }
            
            if (performanceSummary.high_confidence_campaigns > performanceSummary.total_campaigns * 0.7) {
                insights.keyInsights.push({
                    type: 'info',
                    icon: 'fa-shield-alt',
                    title: 'High Confidence Portfolio',
                    description: `${performanceSummary.high_confidence_campaigns} out of ${performanceSummary.total_campaigns} campaigns have high confidence scores, indicating reliable predictions.`
                });
            }
            
            if (performanceSummary.average_conversion_rate > 2.5) {
                insights.keyInsights.push({
                    type: 'success',
                    icon: 'fa-bullseye',
                    title: 'Strong Conversion Performance',
                    description: `Average conversion rate of ${performanceSummary.average_conversion_rate}% exceeds industry benchmarks.`
                });
            }
            
            // Generate recommendations
            const lowPerformingCampaigns = campaigns.filter(c => c.expected_metrics.expected_roi < 50);
            if (lowPerformingCampaigns.length > 0) {
                insights.recommendations.push({
                    priority: 'high',
                    title: 'Optimize Low-ROI Campaigns',
                    description: `${lowPerformingCampaigns.length} campaigns show ROI below 50%. Consider budget reallocation or strategy adjustment.`,
                    impact: 'High - Could improve overall portfolio ROI by 15-25%'
                });
            }
            
            const singleChannelCampaigns = campaigns.filter(c => c.channels.length === 1);
            if (singleChannelCampaigns.length > campaigns.length * 0.5) {
                insights.recommendations.push({
                    priority: 'medium',
                    title: 'Diversify Marketing Channels',
                    description: 'Many campaigns rely on single channels. Multi-channel approaches typically improve performance by 20-30%.',
                    impact: 'Medium - Reduced risk and improved reach'
                });
            }
            
            const highRiskCampaigns = campaigns.filter(c => c.risk_assessment.risk_level === 'High');
            if (highRiskCampaigns.length > 0) {
                insights.recommendations.push({
                    priority: 'high',
                    title: 'Address High-Risk Campaigns',
                    description: `${highRiskCampaigns.length} campaigns have high risk levels. Review targeting and budget allocation.`,
                    impact: 'High - Prevent potential losses and improve success rate'
                });
            }
            
            return insights;
        }
        
        function generatePerformanceDistribution(campaigns) {
            const roiRanges = {
                'Excellent (>200%)': campaigns.filter(c => c.expected_metrics.expected_roi > 200).length,
                'Good (100-200%)': campaigns.filter(c => c.expected_metrics.expected_roi >= 100 && c.expected_metrics.expected_roi <= 200).length,
                'Average (50-100%)': campaigns.filter(c => c.expected_metrics.expected_roi >= 50 && c.expected_metrics.expected_roi < 100).length,
                'Poor (<50%)': campaigns.filter(c => c.expected_metrics.expected_roi < 50).length
            };
            
            const total = campaigns.length;
            
            return Object.entries(roiRanges).map(([range, count]) => {
                const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                return `
                    <div class="distribution-item">
                        <div class="distribution-label">${range}</div>
                        <div class="distribution-bar">
                            <div class="distribution-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="distribution-value">${count} (${percentage}%)</div>
                    </div>
                `;
            }).join('');
        }
        
        function getRiskBadgeColor(riskLevel) {
            switch(riskLevel.toLowerCase()) {
                case 'low': return 'success';
                case 'medium': return 'warning';
                case 'high': return 'danger';
                default: return 'secondary';
            }
        }
        
        function getChannelIcon(channel) {
            const icons = {
                'email': 'envelope',
                'social_media': 'share-alt',
                'search': 'search',
                'display': 'desktop',
                'content': 'file-alt'
            };
            return icons[channel.toLowerCase()] || 'bullhorn';
        }
        
        // Function to clear all campaigns and reset to empty state
        function clearAllCampaigns() {
            campaigns = [];
            agentGeneratedCampaigns = [];
            campaignIdCounter = 1;
            displayCampaignsList();
            updatePerformanceSummary();
            console.log('All campaigns cleared - All Campaign section reset to empty state');
        }
        
        // Campaign Management Functions
        function showCreateCampaignForm() {
            createNewCampaign();
        }
        
        function createNewCampaign() {
            editingCampaignId = null;
            document.getElementById('campaign-form-title').textContent = 'Create New Campaign';
            document.getElementById('campaign-form').reset();
            document.getElementById('campaign-creation').style.display = 'block';
            document.getElementById('campaign-name').focus();
        }
        
        function editCampaign(id) {
            const campaign = campaigns.find(c => c.id === id);
            if (!campaign) return;
            
            editingCampaignId = id;
            document.getElementById('campaign-form-title').textContent = 'Edit Campaign';
            document.getElementById('campaign-name').value = campaign.name;
            document.getElementById('campaign-type').value = campaign.type;
            document.getElementById('campaign-segment').value = campaign.segment;
            document.getElementById('campaign-budget').value = campaign.budget;
            document.getElementById('campaign-creation').style.display = 'block';
        }
        
        function saveCampaign() {
            const name = document.getElementById('campaign-name').value.trim();
            const type = document.getElementById('campaign-type').value;
            const segment = document.getElementById('campaign-segment').value;
            const budget = parseFloat(document.getElementById('campaign-budget').value) || 0;
            
            if (!name) {
                showAlert('Campaign name is required', 'danger');
                return;
            }
            
            if (editingCampaignId) {
                // Update existing campaign
                const campaign = campaigns.find(c => c.id === editingCampaignId);
                if (campaign) {
                    campaign.name = name;
                    campaign.type = type;
                    campaign.segment = segment;
                    campaign.budget = budget;
                    campaign.lastModified = new Date().toISOString().split('T')[0];
                    showAlert('Campaign updated successfully!', 'success');
                }
            } else {
                // Create new campaign
                const newCampaign = {
                    id: Math.max(...campaigns.map(c => c.id), 0) + 1,
                    name: name,
                    type: type,
                    status: 'Draft',
                    segment: segment,
                    budget: budget,
                    spent: 0,
                    impressions: 0,
                    clicks: 0,
                    conversions: 0,
                    created: new Date().toISOString().split('T')[0],
                    lastModified: new Date().toISOString().split('T')[0]
                };
                campaigns.push(newCampaign);
                showAlert('Campaign created successfully!', 'success');
            }
            
            cancelCampaignForm();
            displayCampaignsList();
            updatePerformanceSummary();
        }
        
        function cancelCampaignForm() {
            document.getElementById('campaign-creation').style.display = 'none';
            document.getElementById('campaign-form').reset();
            editingCampaignId = null;
        }
        
        function displayCampaignsList() {
            const campaignsList = document.getElementById('campaigns-list');
            if (!campaignsList) return;
            
            console.log('🔄 displayCampaignsList called with', campaigns.length, 'campaigns');
            
            // Show empty state message if no campaigns
            if (campaigns.length === 0) {
                campaignsList.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No campaigns available. Campaigns will appear here after being approved from the Marketing Campaigns section.</div>';
                return;
            }
            
            campaignsList.innerHTML = campaigns.map(campaign => `
                <div class="campaign-item border rounded p-3 mb-3" data-campaign-id="${campaign.id}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="form-check">
                            <input class="form-check-input campaign-checkbox" type="checkbox" value="${campaign.id}" id="campaign-${campaign.id}">
                            <label class="form-check-label fw-bold" for="campaign-${campaign.id}">
                                ${campaign.name}
                            </label>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="editCampaign(${campaign.id})"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                <li><a class="dropdown-item" href="#" onclick="duplicateCampaign(${campaign.id})"><i class="fas fa-copy me-2"></i>Duplicate</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteCampaign(${campaign.id})"><i class="fas fa-trash me-2"></i>Delete</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-md-3">
                            <small class="text-muted">Type:</small><br>
                            <span class="badge bg-primary">${campaign.type}</span>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Status:</small><br>
                            <span class="badge bg-${getStatusColor(campaign.status)}">${campaign.status}</span>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Budget:</small><br>
                            <strong>$${campaign.budget.toLocaleString()}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Spent:</small><br>
                            <strong>$${campaign.spent.toLocaleString()}</strong>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-3">
                            <small class="text-muted">Impressions:</small><br>
                            <strong>${campaign.impressions.toLocaleString()}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Clicks:</small><br>
                            <strong>${campaign.clicks.toLocaleString()}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Conversions:</small><br>
                            <strong>${campaign.conversions}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">CTR:</small><br>
                            <strong>${campaign.impressions > 0 ? ((campaign.clicks / campaign.impressions) * 100).toFixed(2) : 0}%</strong>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Segment: ${campaign.segment} | Created: ${campaign.created} | Modified: ${campaign.lastModified}</small>
                    </div>
                </div>
            `).join('');
        }
        
        function getStatusColor(status) {
            switch(status.toLowerCase()) {
                case 'active': return 'success';
                case 'paused': return 'warning';
                case 'draft': return 'secondary';
                case 'completed': return 'info';
                default: return 'secondary';
            }
        }
        
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-campaigns');
            const campaignCheckboxes = document.querySelectorAll('.campaign-checkbox');
            
            campaignCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }
        
        function getSelectedCampaigns() {
            const selectedCheckboxes = document.querySelectorAll('.campaign-checkbox:checked');
            return Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
        }
        
        function launchCampaigns() {
            const selectedIds = getSelectedCampaigns();
            if (selectedIds.length === 0) {
                showAlert('Please select campaigns to launch', 'warning');
                return;
            }
            
            selectedIds.forEach(id => {
                const campaign = campaigns.find(c => c.id === id);
                if (campaign && campaign.status !== 'Active') {
                    campaign.status = 'Active';
                    campaign.lastModified = new Date().toISOString().split('T')[0];
                }
            });
            
            showAlert(`${selectedIds.length} campaign(s) launched successfully!`, 'success');
            displayCampaignsList();
            updatePerformanceSummary();
        }
        
        function pauseCampaigns() {
            const selectedIds = getSelectedCampaigns();
            if (selectedIds.length === 0) {
                showAlert('Please select campaigns to pause', 'warning');
                return;
            }
            
            selectedIds.forEach(id => {
                const campaign = campaigns.find(c => c.id === id);
                if (campaign && campaign.status === 'Active') {
                    campaign.status = 'Paused';
                    campaign.lastModified = new Date().toISOString().split('T')[0];
                }
            });
            
            showAlert(`${selectedIds.length} campaign(s) paused successfully!`, 'success');
            displayCampaignsList();
            updatePerformanceSummary();
        }
        
        function deleteSelectedCampaigns() {
            const selectedIds = getSelectedCampaigns();
            if (selectedIds.length === 0) {
                showAlert('Please select campaigns to delete', 'warning');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedIds.length} campaign(s)? This action cannot be undone.`)) {
                campaigns = campaigns.filter(campaign => !selectedIds.includes(campaign.id));
                showAlert(`${selectedIds.length} campaign(s) deleted successfully!`, 'success');
                displayCampaignsList();
                updatePerformanceSummary();
            }
        }
        
        function deleteCampaign(id) {
            if (confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) {
                campaigns = campaigns.filter(campaign => campaign.id !== id);
                showAlert('Campaign deleted successfully!', 'success');
                displayCampaignsList();
                updatePerformanceSummary();
            }
        }
        
        function duplicateCampaign(id) {
            const campaign = campaigns.find(c => c.id === id);
            if (!campaign) return;
            
            const newCampaign = {
                ...campaign,
                id: Math.max(...campaigns.map(c => c.id), 0) + 1,
                name: campaign.name + ' (Copy)',
                status: 'Draft',
                spent: 0,
                impressions: 0,
                clicks: 0,
                conversions: 0,
                created: new Date().toISOString().split('T')[0],
                lastModified: new Date().toISOString().split('T')[0]
            };
            
            campaigns.push(newCampaign);
            showAlert('Campaign duplicated successfully!', 'success');
            displayCampaignsList();
            updatePerformanceSummary();
        }
        
        function refreshCampaigns() {
            showAlert('Campaigns refreshed!', 'info');
            displayCampaignsList();
            updatePerformanceSummary();
        }
        
        function analyzeCampaigns() {
            const selectedIds = getSelectedCampaigns();
            if (selectedIds.length === 0) {
                showAlert('Please select campaigns to analyze', 'warning');
                return;
            }
            
            const selectedCampaigns = campaigns.filter(c => selectedIds.includes(c.id));
            const totalSpent = selectedCampaigns.reduce((sum, c) => sum + c.spent, 0);
            const totalImpressions = selectedCampaigns.reduce((sum, c) => sum + c.impressions, 0);
            const totalClicks = selectedCampaigns.reduce((sum, c) => sum + c.clicks, 0);
            const totalConversions = selectedCampaigns.reduce((sum, c) => sum + c.conversions, 0);
            
            const avgCTR = totalImpressions > 0 ? ((totalClicks / totalImpressions) * 100).toFixed(2) : 0;
            const avgConversionRate = totalClicks > 0 ? ((totalConversions / totalClicks) * 100).toFixed(2) : 0;
            
            showAlert(`Analysis for ${selectedIds.length} campaign(s): Total Spent: $${totalSpent.toLocaleString()}, CTR: ${avgCTR}%, Conversion Rate: ${avgConversionRate}%`, 'info');
        }
        
        function updatePerformanceSummary() {
            const activeCampaigns = campaigns.filter(c => c.status === 'Active');
            const totalBudget = campaigns.reduce((sum, c) => sum + c.budget, 0);
            const totalSpent = campaigns.reduce((sum, c) => sum + c.spent, 0);
            const totalImpressions = campaigns.reduce((sum, c) => sum + c.impressions, 0);
            const totalClicks = campaigns.reduce((sum, c) => sum + c.clicks, 0);
            const totalConversions = campaigns.reduce((sum, c) => sum + c.conversions, 0);
            
            document.getElementById('active-campaigns-count').textContent = activeCampaigns.length;
            document.getElementById('total-budget').textContent = `$${totalBudget.toLocaleString()}`;
            document.getElementById('total-spent').textContent = `$${totalSpent.toLocaleString()}`;
            document.getElementById('total-impressions').textContent = totalImpressions.toLocaleString();
            document.getElementById('total-clicks').textContent = totalClicks.toLocaleString();
            document.getElementById('total-conversions').textContent = totalConversions;
            
            const overallCTR = totalImpressions > 0 ? ((totalClicks / totalImpressions) * 100).toFixed(2) : 0;
            const overallConversionRate = totalClicks > 0 ? ((totalConversions / totalClicks) * 100).toFixed(2) : 0;
            
            document.getElementById('overall-ctr').textContent = `${overallCTR}%`;
            document.getElementById('overall-conversion-rate').textContent = `${overallConversionRate}%`;
        }
        
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-custom`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            alertsContainer.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        function updateStats() {
            document.getElementById('files-processed').textContent = filesProcessed;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }
        
        // Check system status on load
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'healthy') {
                    document.getElementById('agent1-status').textContent = 'Ready';
                    document.getElementById('agent2-status').textContent = 'Ready';
                } else {
                    showAlert('System status check failed', 'warning');
                }
            })
            .catch(error => {
                showAlert('Unable to check system status', 'warning');
            });
        
        // Smooth scrolling for navigation links and active state management
        document.querySelectorAll('.nav-link[href^="#"]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all nav links
                document.querySelectorAll('.nav-link').forEach(navLink => {
                    navLink.classList.remove('active');
                });
                
                // Add active class to clicked link
                this.classList.add('active');
                
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
        
        // Update active navigation based on scroll position
        function updateActiveNavigation() {
            const sections = ['upload-section', 'process-section', 'campaigns-section', 'campaign-management', 'results-section'];
            const navLinks = document.querySelectorAll('.nav-link[href^="#"]');
            
            let currentSection = null;
            
            // Check which section is currently visible
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    const rect = section.getBoundingClientRect();
                    // Check if section is in viewport (at least 50% visible)
                    if (rect.top <= window.innerHeight * 0.5 && rect.bottom >= window.innerHeight * 0.5) {
                        currentSection = sectionId;
                    }
                }
            });
            
            // Update active state
            navLinks.forEach(link => {
                link.classList.remove('active');
                const href = link.getAttribute('href');
                if (href === `#${currentSection}`) {
                    link.classList.add('active');
                } else if (!currentSection && href === '#') {
                    // Default to dashboard if no section is active
                    link.classList.add('active');
                }
            });
        }
        
        // Listen for scroll events to update active navigation
        window.addEventListener('scroll', updateActiveNavigation);
        
        // Initial call to set correct active state
        updateActiveNavigation();
        
        // Refresh page function
        function refreshPage() {
            const refreshBtn = document.querySelector('button[onclick="refreshPage()"]');
            const originalContent = refreshBtn.innerHTML;
            
            // Show loading state
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            refreshBtn.disabled = true;
            
            // Reload the page
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }
        
        // Clear cache function
        function clearCache() {
            const clearBtn = document.querySelector('button[onclick="clearCache()"]');
            const originalContent = clearBtn.innerHTML;
            
            // Show confirmation dialog
            if (!confirm('Are you sure you want to clear the cache and memory? This will reset all agent data and context.')) {
                return;
            }
            
            // Show loading state
            clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clearing...';
            clearBtn.disabled = true;
            
            // Make API call to clear cache
            fetch('/clear_cache', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Cache cleared successfully! The page will refresh.', 'success');
                    
                    // Clear UI elements
                    document.getElementById('segments-container').innerHTML = '';
                    document.getElementById('goals-container').innerHTML = '';
                    document.getElementById('campaigns-container').innerHTML = '';
                    document.getElementById('implementation-container').innerHTML = '';
                    document.getElementById('thinking-entries').innerHTML = '';
                    
                    // Reset agent status
                    document.getElementById('agent1-status').textContent = 'Ready';
                    document.getElementById('agent2-status').textContent = 'Ready';
                    document.getElementById('files-processed').textContent = '0';
                    
                    // Refresh page after 2 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showAlert(`Error clearing cache: ${data.message}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Error clearing cache:', error);
                showAlert('Error clearing cache. Please try again.', 'danger');
            })
            .finally(() => {
                // Restore button state
                clearBtn.innerHTML = originalContent;
                clearBtn.disabled = false;
            });
        }
        
        // Chat Widget Functions
        let chatSocket = null;
        let isChatExpanded = true;
        
        function initializeChatSocket() {
            if (!chatSocket) {
                chatSocket = io();
                
                chatSocket.on('chat_response', function(data) {
                    hideTypingIndicator();
                    displayChatMessage(data.message.content, 'assistant');
                });
                
                chatSocket.on('connect', function() {
                    console.log('Chat connected to server');
                });
                
                chatSocket.on('disconnect', function() {
                    console.log('Chat disconnected from server');
                });
            }
        }
        
        function toggleChatWidget() {
            const container = document.getElementById('chat-widget-container');
            const toggleBtn = document.getElementById('chat-toggle-btn');
            const toggleIcon = document.getElementById('chat-toggle-icon');
            
            if (isChatExpanded) {
                container.classList.add('collapsed');
                toggleIcon.className = 'fas fa-compress';
                isChatExpanded = false;
            } else {
                container.classList.remove('collapsed');
                toggleIcon.className = 'fas fa-expand';
                isChatExpanded = true;
            }
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Display user message
            displayChatMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Send message to server
            fetch('/api/chat/message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    context: {}
                })
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                if (data.result && data.result.message) {
                    displayChatMessage(data.result.message.content, 'assistant');
                } else {
                    displayChatMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                }
            })
            .catch(error => {
                hideTypingIndicator();
                console.error('Chat error:', error);
                displayChatMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            });
        }
        
        function sendQuickMessage(message) {
            document.getElementById('chat-input').value = message;
            sendChatMessage();
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        function displayChatMessage(content, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${sender}">
                    ${content}
                </div>
                <div class="message-time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function showTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'block';
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function hideTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'none';
        }
        
        // Results Section Functions
        function exportResults(format) {
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            let filename, content, mimeType;
            
            // Gather all results data
            const resultsData = {
                timestamp: new Date().toISOString(),
                overview: {
                    totalSegments: document.getElementById('total-segments').textContent || '0',
                    totalGoals: document.getElementById('total-goals').textContent || '0',
                    totalCampaigns: document.getElementById('total-campaigns-result').textContent || '0',
                    processingTime: document.getElementById('processing-time').textContent || '0s'
                },
                agentResults: {
                    agent1: document.getElementById('agent1-results-content').innerHTML,
                    agent2: document.getElementById('agent2-results-content').innerHTML,
                    combined: document.getElementById('combined-results-content').innerHTML
                },
                analytics: {
                    segments: document.getElementById('segments-analytics-content').innerHTML,
                    campaigns: document.getElementById('campaigns-analytics-content').innerHTML,
                    dataQuality: document.getElementById('data-quality-content').innerHTML
                },
                performance: {
                    agent1ProcessingTime: document.getElementById('agent1-processing-time').textContent || '0s',
                    agent2ProcessingTime: document.getElementById('agent2-processing-time').textContent || '0s',
                    totalProcessingTime: document.getElementById('total-processing-time').textContent || '0s',
                    dataProcessingRate: document.getElementById('data-processing-rate').textContent || '0 records/s'
                },
                insights: {
                    keyInsights: document.getElementById('key-insights-content').innerHTML,
                    recommendations: document.getElementById('recommendations-content').innerHTML,
                    actionItems: document.getElementById('action-items-content').innerHTML
                }
            };
            
            if (format === 'json') {
                content = JSON.stringify(resultsData, null, 2);
                mimeType = 'application/json';
                filename = `results_export_${timestamp}.json`;
            } else if (format === 'excel') {
                // Create CSV format for Excel compatibility
                const csvRows = [
                    ['Section', 'Metric', 'Value'],
                    ['Overview', 'Total Segments', resultsData.overview.totalSegments],
                    ['Overview', 'Total Goals', resultsData.overview.totalGoals],
                    ['Overview', 'Total Campaigns', resultsData.overview.totalCampaigns],
                    ['Overview', 'Processing Time', resultsData.overview.processingTime],
                    ['Performance', 'Agent 1 Processing Time', resultsData.performance.agent1ProcessingTime],
                    ['Performance', 'Agent 2 Processing Time', resultsData.performance.agent2ProcessingTime],
                    ['Performance', 'Total Processing Time', resultsData.performance.totalProcessingTime],
                    ['Performance', 'Data Processing Rate', resultsData.performance.dataProcessingRate]
                ];
                content = csvRows.map(row => row.join(',')).join('\n');
                mimeType = 'text/csv';
                filename = `results_export_${timestamp}.csv`;
            }
            
            // Create and trigger download
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert(`Results exported as ${format.toUpperCase()} successfully!`, 'success');
        }
        
        function refreshResults() {
            // Show loading state
            const refreshBtn = document.querySelector('button[onclick="refreshResults()"]');
            const originalContent = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
            refreshBtn.disabled = true;
            
            // Simulate refresh (in real implementation, this would fetch from API)
            setTimeout(() => {
                // Reset to original state
                refreshBtn.innerHTML = originalContent;
                refreshBtn.disabled = false;
                showAlert('Results refreshed successfully!', 'success');
                
                // Update timestamp in overview
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                // You can add timestamp display logic here
            }, 1500);
        }
        
        function updateResultsOverview(data) {
            // Update overview cards with new data
            if (data.segments) {
                document.getElementById('total-segments').textContent = data.segments;
            }
            if (data.goals) {
                document.getElementById('total-goals').textContent = data.goals;
            }
            if (data.campaigns) {
                document.getElementById('total-campaigns-result').textContent = data.campaigns;
            }
            if (data.processingTime) {
                document.getElementById('processing-time').textContent = data.processingTime;
            }
        }
        
        function updateAgentResults(agentId, results) {
            const contentId = `agent${agentId}-results-content`;
            const contentElement = document.getElementById(contentId);
            
            if (contentElement && results) {
                contentElement.innerHTML = `
                    <div class="results-data">
                        <h6>Processing Results:</h6>
                        <pre class="bg-light p-3 rounded">${JSON.stringify(results, null, 2)}</pre>
                    </div>
                `;
            }
        }
        
        function updatePerformanceMetrics(metrics) {
            if (metrics.agent1Time) {
                document.getElementById('agent1-processing-time').textContent = metrics.agent1Time;
            }
            if (metrics.agent2Time) {
                document.getElementById('agent2-processing-time').textContent = metrics.agent2Time;
            }
            if (metrics.totalTime) {
                document.getElementById('total-processing-time').textContent = metrics.totalTime;
            }
            if (metrics.processingRate) {
                document.getElementById('data-processing-rate').textContent = metrics.processingRate;
            }
        }
        
        function updatePerformanceMetricsFromAgent(result, agentType) {
            const processingTime = result.processing_time || result.execution_time || 'N/A';
            const elementId = agentType === 'agent1' ? 'agent1-processing-time' : 'agent2-processing-time';
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = processingTime;
            }
        }
        
        function updateFinalPerformanceMetrics(agent1Result, agent2Result, timestamp) {
            const agent1Time = agent1Result?.processing_time || agent1Result?.execution_time || 0;
            const agent2Time = agent2Result?.processing_time || agent2Result?.execution_time || 0;
            
            // Calculate total time
            let totalTime = 'N/A';
            if (agent1Time && agent2Time) {
                const total = parseFloat(agent1Time) + parseFloat(agent2Time);
                totalTime = total.toFixed(2) + 's';
            }
            
            // Calculate processing rate
            const segmentsCount = agent1Result?.segments?.length || 0;
            const campaignsCount = agent1Result?.campaigns?.length || 0;
            const totalItems = segmentsCount + campaignsCount;
            let processingRate = 'N/A';
            if (totalTime !== 'N/A' && totalItems > 0) {
                const rate = totalItems / parseFloat(totalTime);
                processingRate = rate.toFixed(2) + ' items/sec';
            }
            
            updatePerformanceMetrics({
                agent1Time: agent1Time + 's',
                agent2Time: agent2Time + 's',
                totalTime: totalTime,
                processingRate: processingRate
            });
        }
        
        function addInsight(type, content) {
            const contentId = type === 'insight' ? 'key-insights-content' : 
                             type === 'recommendation' ? 'recommendations-content' : 
                             'action-items-content';
            
            const contentElement = document.getElementById(contentId);
            if (contentElement) {
                // Replace placeholder or add to existing content
                if (contentElement.innerHTML.includes('text-center text-muted')) {
                    contentElement.innerHTML = '';
                }
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'insight-item mb-3 p-3 border-start border-primary border-3 bg-light';
                itemDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <p class="mb-1">${content}</p>
                            <small class="text-muted">${new Date().toLocaleString()}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                contentElement.appendChild(itemDiv);
            }
        }
        
        function populateAnalyticsSection(agent1Result, agent2Result) {
            // Populate Customer Segments Analytics
            const segmentsContent = document.getElementById('customer-segments-content');
            if (segmentsContent && agent1Result?.segments) {
                const segments = agent1Result.segments;
                const highPrioritySegments = segments.filter(s => s.priority_score >= 7).length;
                const avgPriorityScore = segments.reduce((sum, s) => sum + (s.priority_score || 0), 0) / segments.length;
                
                segmentsContent.innerHTML = `
                    <div class="analytics-data">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="metric-card text-center p-3 border rounded">
                                    <h4 class="text-primary">${segments.length}</h4>
                                    <small>Total Segments</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card text-center p-3 border rounded">
                                    <h4 class="text-success">${highPrioritySegments}</h4>
                                    <small>High Priority</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card text-center p-3 border rounded">
                                    <h4 class="text-info">${avgPriorityScore.toFixed(1)}</h4>
                                    <small>Avg Priority Score</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Populate Campaign Performance Analytics
            const campaignContent = document.getElementById('campaign-performance-content');
            if (campaignContent && agent1Result?.campaigns) {
                const campaigns = agent1Result.campaigns;
                const channelCounts = {};
                campaigns.forEach(campaign => {
                    if (campaign.channels) {
                        campaign.channels.forEach(channel => {
                            channelCounts[channel] = (channelCounts[channel] || 0) + 1;
                        });
                    }
                });
                
                const topChannels = Object.entries(channelCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3);
                
                campaignContent.innerHTML = `
                    <div class="analytics-data">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Campaign Distribution</h6>
                                <div class="metric-card p-3 border rounded">
                                    <div class="d-flex justify-content-between">
                                        <span>Total Campaigns:</span>
                                        <strong>${campaigns.length}</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Top Channels</h6>
                                <div class="metric-card p-3 border rounded">
                                    ${topChannels.map(([channel, count]) => `
                                        <div class="d-flex justify-content-between">
                                            <span>${channel}:</span>
                                            <strong>${count}</strong>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Populate Data Quality Metrics
            const dataQualityContent = document.getElementById('data-quality-content');
            if (dataQualityContent) {
                const segmentsCount = agent1Result?.segments?.length || 0;
                const goalsCount = agent1Result?.business_goals?.length || 0;
                const campaignsCount = agent1Result?.campaigns?.length || 0;
                const completeness = ((segmentsCount > 0 ? 1 : 0) + (goalsCount > 0 ? 1 : 0) + (campaignsCount > 0 ? 1 : 0)) / 3 * 100;
                
                dataQualityContent.innerHTML = `
                    <div class="analytics-data">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="metric-card text-center p-3 border rounded">
                                    <h4 class="text-success">${completeness.toFixed(0)}%</h4>
                                    <small>Data Completeness</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card text-center p-3 border rounded">
                                    <h4 class="text-info">${segmentsCount + goalsCount + campaignsCount}</h4>
                                    <small>Total Items Generated</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card text-center p-3 border rounded">
                                    <h4 class="text-primary">High</h4>
                                    <small>Quality Score</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function populateInsightsSection(agent1Result, agent2Result) {
            // Generate Key Insights
            const keyInsightsContent = document.getElementById('key-insights-content');
            if (keyInsightsContent) {
                keyInsightsContent.innerHTML = '';
                
                if (agent1Result?.segments) {
                    const segments = agent1Result.segments;
                    const highPriorityCount = segments.filter(s => s.priority_score >= 7).length;
                    if (highPriorityCount > 0) {
                        addInsight('insight', `Identified ${highPriorityCount} high-priority customer segments with strong business potential.`);
                    }
                }
                
                if (agent1Result?.campaigns) {
                    const campaigns = agent1Result.campaigns;
                    addInsight('insight', `Generated ${campaigns.length} targeted marketing campaigns across multiple channels.`);
                }
                
                if (agent2Result?.execution_strategy) {
                    addInsight('insight', 'Implementation strategy developed with detailed execution plan and performance tracking.');
                }
            }
            
            // Generate AI Recommendations
            const recommendationsContent = document.getElementById('recommendations-content');
            if (recommendationsContent) {
                recommendationsContent.innerHTML = '';
                
                if (agent1Result?.segments) {
                    const segments = agent1Result.segments;
                    const topSegment = segments.reduce((max, segment) => 
                        (segment.priority_score || 0) > (max.priority_score || 0) ? segment : max, segments[0]);
                    
                    if (topSegment) {
                        addInsight('recommendation', `Focus initial efforts on "${topSegment.name}" segment due to highest priority score of ${topSegment.priority_score}/10.`);
                    }
                }
                
                if (agent1Result?.campaigns) {
                    addInsight('recommendation', 'Implement campaigns in phases, starting with highest-priority segments for maximum ROI.');
                }
                
                addInsight('recommendation', 'Monitor performance metrics closely during initial rollout to optimize campaign effectiveness.');
            }
        }
        
        // Initialize results section when page loads
        function initializeResultsSection() {
            // Set up tab switching functionality
            const tabButtons = document.querySelectorAll('#results-tabs button[data-bs-toggle="tab"]');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Update active states
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding tab pane
                    const targetPane = document.querySelector(this.getAttribute('data-bs-target'));
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    if (targetPane) {
                        targetPane.classList.add('show', 'active');
                    }
                });
            });
            
            // Listen for agent results via SocketIO
            if (typeof socket !== 'undefined') {
                socket.on('agent_status', function(data) {
                    handleAgentStatusUpdate(data);
                });
            }
        }
        
        function handleAgentStatusUpdate(data) {
            const status = data.status;
            const result = data.result || data.agent1_result || data.agent2_result;
            
            // Update processing status
            if (data.message) {
                updateProcessingStatus(data.message, status);
            }
            
            // Handle Agent 1 results
            if (status === 'agent1_complete' && data.result) {
                populateAgent1Results(data.result);
                populateAnalyticsSection(data.result, null);
                updatePerformanceMetricsFromAgent(data.result, 'agent1');
            }
            
            // Handle Agent 2 results  
            if (status === 'agent2_complete' || (status === 'completed' && data.agent2_result)) {
                populateAgent2Results(data.agent2_result);
                updatePerformanceMetricsFromAgent(data.agent2_result, 'agent2');
            }
            
            // Handle final completion
            if (status === 'completed') {
                populateFinalResults(data.agent1_result, data.agent2_result);
                populateAnalyticsSection(data.agent1_result, data.agent2_result);
                populateInsightsSection(data.agent1_result, data.agent2_result);
                updateFinalPerformanceMetrics(data.agent1_result, data.agent2_result, data.timestamp);
            }
        }
        
        function updateProcessingStatus(message, status) {
            const statusElement = document.getElementById('processing-status');
            if (statusElement) {
                const statusClass = status === 'error' ? 'text-danger' : 
                                  status === 'completed' ? 'text-success' : 'text-primary';
                statusElement.innerHTML = `<span class="${statusClass}">${message}</span>`;
            }
        }
        
        function populateAgent1Results(result) {
            // Update overview with Agent 1 data
            if (result.segments) {
                updateResultsOverview({
                    segments: result.segments.length.toString(),
                    goals: result.business_goals ? result.business_goals.length.toString() : '0',
                    campaigns: result.campaigns ? result.campaigns.length.toString() : '0'
                });
            }
            
            // Populate Agent 1 results content
            const agent1Content = document.getElementById('agent1-results-content');
            if (agent1Content && result) {
                agent1Content.innerHTML = `
                    <div class="results-data">
                        <h6>Customer Segments Generated:</h6>
                        <div class="row">
                            ${result.segments ? result.segments.map(segment => `
                                <div class="col-md-6 mb-3">
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <h6 class="card-title">${segment.name}</h6>
                                            <p class="card-text small">${segment.description}</p>
                                            <div class="badge bg-primary">${segment.priority_score}/10 Priority</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<p>No segments generated</p>'}
                        </div>
                        
                        <h6 class="mt-4">Business Goals:</h6>
                        <div class="list-group">
                            ${result.business_goals ? result.business_goals.map(goal => `
                                <div class="list-group-item">
                                    <h6>${goal.name}</h6>
                                    <p class="mb-1">${goal.description}</p>
                                    <small class="text-muted">Priority: ${goal.priority}</small>
                                </div>
                            `).join('') : '<p>No goals generated</p>'}
                        </div>
                        
                        <h6 class="mt-4">Marketing Campaigns:</h6>
                        <div class="row">
                            ${result.campaigns ? result.campaigns.map(campaign => `
                                <div class="col-md-12 mb-3">
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <h6 class="card-title">${campaign.name}</h6>
                                            <p class="card-text small">${campaign.description}</p>
                                            <div class="d-flex gap-2">
                                                <span class="badge bg-info">${campaign.channels ? campaign.channels.join(', ') : 'Multi-channel'}</span>
                                                <span class="badge bg-warning">${campaign.budget_estimate || 'Budget TBD'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<p>No campaigns generated</p>'}
                        </div>
                    </div>
                `;
            }
        }
        
        function populateAgent2Results(result) {
            const agent2Content = document.getElementById('agent2-results-content');
            if (agent2Content && result) {
                agent2Content.innerHTML = `
                    <div class="results-data">
                        <h6>Implementation Strategy:</h6>
                        <div class="card border-success mb-3">
                            <div class="card-body">
                                <h6>Execution Plan</h6>
                                <pre class="bg-light p-3 rounded small">${JSON.stringify(result.execution_strategy || {}, null, 2)}</pre>
                            </div>
                        </div>
                        
                        <h6>Performance Tracking:</h6>
                        <div class="card border-info">
                            <div class="card-body">
                                <pre class="bg-light p-3 rounded small">${JSON.stringify(result.performance_tracking || {}, null, 2)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function populateFinalResults(agent1Result, agent2Result) {
            // Update combined results
            const combinedContent = document.getElementById('combined-results-content');
            if (combinedContent) {
                combinedContent.innerHTML = `
                    <div class="results-summary">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Agent 1 Summary</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-users text-primary"></i> ${agent1Result.segments ? agent1Result.segments.length : 0} Segments</li>
                                    <li><i class="fas fa-bullseye text-success"></i> ${agent1Result.business_goals ? agent1Result.business_goals.length : 0} Goals</li>
                                    <li><i class="fas fa-campaign text-info"></i> ${agent1Result.campaigns ? agent1Result.campaigns.length : 0} Campaigns</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Agent 2 Summary</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-cogs text-primary"></i> Implementation Strategy</li>
                                    <li><i class="fas fa-chart-line text-success"></i> Performance Tracking</li>
                                    <li><i class="fas fa-lightbulb text-warning"></i> AI Recommendations</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Add insights based on results
            if (agent1Result.segments && agent1Result.segments.length > 0) {
                addInsight('insight', `Generated ${agent1Result.segments.length} customer segments with varying priority scores`);
            }
            
            if (agent2Result.execution_strategy) {
                addInsight('recommendation', 'Implementation strategy includes multi-channel approach and performance tracking');
            }
            
            // Update final processing time
            updatePerformanceMetrics({
                totalTime: calculateProcessingTime(agent1Result, agent2Result)
            });
        }
        
        function calculateProcessingTime(agent1Result, agent2Result) {
            // Calculate approximate processing time based on results
            const segmentCount = agent1Result && agent1Result.segments ? agent1Result.segments.length : 0;
            const goalCount = agent1Result && agent1Result.business_goals ? agent1Result.business_goals.length : 0;
            const estimatedTime = (segmentCount * 0.5) + (goalCount * 0.3) + 2; // Rough estimate
            return `${estimatedTime.toFixed(1)}s`;
        }
        
        // Initialize chat when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeChatSocket();
            initializeResultsSection();
        });
    </script>
</body>
</html>